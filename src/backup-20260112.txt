import React, { useState, useRef, useEffect } from 'react';
import {
  MapPin, Search, Wrench, Key, Zap, Droplet, Star,
  Clock, Shield, User, MessageCircle, Ticket,
  Grid, ChevronLeft, ChevronRight, X, Megaphone,
  Phone, CheckCircle, Send, MoreVertical, Headphones,
  Wallet, CreditCard, Globe, HelpCircle, LogOut, Settings,
  Plus, Camera, ChevronDown, Trash2, Filter, AlertTriangle, 
  Briefcase, Power, Laptop, ArrowRight, Users, MessageSquare,
  ThumbsUp, Share2, CornerUpRight, Navigation, Image, Eye, EyeOff,
  Award, BarChart, Smartphone, FileText, ArrowUpRight, Bell, Lock,
} from 'lucide-react';

// ==========================================
// 1. èµ„æºå¼•å…¥
// ==========================================
import IconLockSmith from './assets/img/icons/icon-cat-lock-smith-service.png';
import IconPlumbingElect from './assets/img/icons/icon-cat-plumbing-electrical-repair.png';
import IconHomeAppRepair from './assets/img/icons/icon-cat-home-appliance-repair.png';
import IconHouseKeepClean from './assets/img/icons/icon-cat-house-keeping-cleaning.png';
import IconAirConRepair from './assets/img/icons/icon-cat-air-conditioning-repair.png';
import IconPaintCoat from './assets/img/icons/icon-cat-painting-coating.png';
import IconFurnitureWork from './assets/img/icons/icon-cat-carpentry-furniture-work.png';
import IconGardenService from './assets/img/icons/icon-cat-gardening-service.png';
import IconMovingService from './assets/img/icons/icon-cat-moving-service.png';
import IconPestControl from './assets/img/icons/icon-cat-pest-control-service.png';
import IconCarRepair from './assets/img/icons/icon-cat-car-repair.png';
import IconComputerRepair from './assets/img/icons/icon-cat-computer-repair.png';
import IconRoofRepair from './assets/img/icons/icon-cat-roof-repair.png';
import IconFlooring from './assets/img/icons/icon-cat-flooring-installation.png';
import IconDoorWindow from './assets/img/icons/icon-cat-door-window-repair.png';
import IconSolarPanel from './assets/img/icons/icon-cat-solar-panel-installation.png';

import { translations } from './translations';

// ==========================================
// 2. æ¨¡æ‹Ÿæ•°æ® (Mock Data)
// ==========================================
const categories = [
  { id: 1, label: "cat_lock", icon: <Key />, color: "bg-purple-100 text-purple-600", type: "cat_lock" },
  { id: 2, label: "cat_plumbing", icon: <Droplet />, color: "bg-blue-100 text-brand-blue", type: "cat_plumbing" },
  { id: 3, label: "cat_electric", icon: <Zap />, color: "bg-yellow-100 text-yellow-600", type: "cat_electric" },
  { id: 4, label: "cat_repair", icon: <Wrench />, color: "bg-green-100 text-green-600", type: "cat_repair" },
  { id: 5, label: "cat_more", icon: <Grid />, color: "bg-gray-100 text-gray-600", action: "more" },
];

const moreServices = [
  { label: "svc_lock", icon: IconLockSmith, type: "cat_lock" },
  { label: "svc_plumb", icon: IconPlumbingElect, type: "cat_plumbing" },
  { label: "svc_home_app_repair", icon: IconHomeAppRepair, type: "cat_repair" },
  { label: "svc_house_cleaning", icon: IconHouseKeepClean, type: "svc_clean" },
  { label: "svc_aircon_repair", icon: IconAirConRepair, type: "svc_ac" },
  { label: "svc_paint_coat", icon: IconPaintCoat, type: "svc_reno" },
  { label: "svc_furniture", icon: IconFurnitureWork, type: "svc_reno" },
  { label: "svc_garden_service", icon: IconGardenService, type: "svc_clean" },
  { label: "svc_moving_service", icon: IconMovingService, type: "svc_moving" },
  { label: "svc_pest_control", icon: IconPestControl, type: "svc_pest" },
  { label: "svc_car_repair", icon: IconCarRepair, type: "cat_repair" },
  { label: "svc_computer_repair", icon: IconComputerRepair, type: "cat_repair" },
  { label: "svc_roof_repair", icon: IconRoofRepair, type: "svc_reno" },
  { label: "svc_flooring", icon: IconFlooring, type: "svc_reno" },
  { label: "svc_door_window", icon: IconDoorWindow, type: "svc_reno" },
  { label: "svc_solar_panel", icon: IconSolarPanel, type: "cat_electric" },
];

const promotions = [
  { id: 1, title: "promo_1_title", sub: "promo_1_sub", color: "from-blue-500 to-blue-700" },
  { id: 2, title: "promo_2_title", sub: "promo_2_sub", color: "from-green-500 to-emerald-700" },
  { id: 3, title: "promo_3_title", sub: "promo_3_sub", color: "from-orange-400 to-red-500" },
];

const sifuData = [
  { id: 1, name: "ç‹å¸ˆå‚… (Sifu Ong)", category: "cat_lock", skill: "å¼€é”ä¸“å®¶", rating: 4.9, jobs: 128, dist: "0.5km", price: "RM 80èµ·", status: "ç©ºé—²", bio: "æ‹¥æœ‰15å¹´å¼€é”ç»éªŒï¼Œä¸“æ”»å„ç±»é˜²ç›—é—¨ã€æ±½è½¦é”ã€‚æ‰¿è¯ºæ— æŸå¼€é”ï¼Œ30åˆ†é’Ÿå¿…è¾¾ã€‚", reviews: ["æŠ€æœ¯å¾ˆå¥½ï¼", "å‡†æ—¶åˆ°è¾¾ã€‚"] },
  { id: 2, name: "Ah Seng ç”µå·¥", category: "cat_electric", skill: "ç”µè·¯ç»´ä¿®", rating: 4.7, jobs: 85, dist: "1.2km", price: "RM 60èµ·", status: "å¿™ç¢Œ", bio: "æŒç‰Œä¸“ä¸šç”µå·¥ï¼Œæ“…é•¿è§£å†³è·³é—¸ã€æ¼ç”µã€çº¿è·¯è€åŒ–é—®é¢˜ã€‚å®‰å…¨ç¬¬ä¸€ã€‚", reviews: ["å¾ˆç»†å¿ƒã€‚"] },
  { id: 3, name: "Ali æ°´ç®¡", category: "cat_plumbing", skill: "ç–é€šä¸‹æ°´é“", rating: 4.8, jobs: 210, dist: "2.3km", price: "RM 50èµ·", status: "ç©ºé—²", bio: "ä¸“æ²»å„ç§å µå¡ï¼Œä¸é€šä¸æ”¶è´¹ã€‚è‡ªå¸¦ä¸“ä¸šç–é€šæœºå™¨ã€‚", reviews: ["Friendly service."] },
  { id: 4, name: "Ken Aircon", category: "svc_ac", skill: "å†·æ°”æ¸…æ´—/åŠ æ°Ÿ", rating: 4.6, jobs: 320, dist: "3.5km", price: "RM 100èµ·", status: "ç©ºé—²", bio: "ä¸“ä¸šå†·æ°”æ¸…æ´—ï¼ŒåŒ…å«è¯æ°´æ´—ã€æ‹†æœºæ´—ã€‚", reviews: ["å¾ˆå¹²å‡€ï¼Œå†·æ°”å˜å†·äº†ã€‚"] },
  { id: 5, name: "Muthu Mover", category: "svc_moving", skill: "æ¬å®¶æœåŠ¡", rating: 5.0, jobs: 45, dist: "5.0km", price: "RM 150èµ·", status: "ç©ºé—²", bio: "æä¾› 1å¨/3å¨ ç½—é‡Œï¼ŒåŒ…å«æ¬è¿å·¥ã€‚", reviews: ["Fast and careful."] }
];

const activeOrder = {
  id: "ORD-8823", sifuName: "ç‹å¸ˆå‚… (Sifu Ong)", service: "å¤§é—¨å¼€é”æœåŠ¡", price: "RM 80.00", status: "èµ¶å¾€ç°åœºä¸­", eta: "5 åˆ†é’Ÿ",
  timeline: [
    { time: "14:30", text: "è®¢å•å·²ç¡®è®¤", done: true },
    { time: "14:32", text: "ç‹å¸ˆå‚…å·²æ¥å•", done: true },
    { time: "14:35", text: "å¸ˆå‚…æ­£åœ¨èµ¶å¾€ç°åœº", done: false, current: true },
    { time: "--:--", text: "å¸ˆå‚…åˆ°è¾¾", done: false },
    { time: "--:--", text: "æœåŠ¡å®Œæˆ", done: false },
  ]
};

const pastOrders = [
  { id: "ORD-1022", sifu: "Ali æ°´ç®¡", service: "å¨æˆ¿ç–é€š", date: "2023-10-05", price: "RM 120", status: "å·²å®Œæˆ" },
  { id: "ORD-0911", sifu: "Ah Seng ç”µå·¥", service: "æ›´æ¢æ’åº§", date: "2023-09-28", price: "RM 60", status: "å·²å®Œæˆ" },
];

const vouchersData = [
  { id: 1, type: "cash", title: "v_1_title", value: "RM 15", sub: "OFF", condition: "v_1_cond", expiry: "v_1_exp", color: "from-brand-orange to-red-500" },
  { id: 2, type: "discount", title: "v_2_title", value: "10%", sub: "DISCOUNT", condition: "v_2_cond", expiry: "v_2_exp", color: "from-blue-500 to-blue-600" },
  { id: 3, type: "free", title: "v_3_title", value: "Free", sub: "VISIT", condition: "v_3_cond", expiry: "v_3_exp", color: "from-green-500 to-emerald-600" },
];

const chatList = [
  { id: 1, name: "ç‹å¸ˆå‚… (Sifu Ong)", lastMsg: "å¥½çš„è€æ¿ï¼Œæˆ‘åˆ°äº†ç»™ä½ ç”µè¯ã€‚", time: "14:35", unread: 2, avatar: <Key size={20}/>, bg: "bg-purple-100 text-purple-600" },
  { id: 2, name: "Sifu-Go å®¢æœä¸­å¿ƒ", lastMsg: "æ‚¨çš„RM15ä¼˜æƒ åˆ¸å·²åˆ°è´¦ï¼Œè¯·æŸ¥æ”¶ã€‚", time: "æ˜¨å¤©", unread: 0, avatar: <Headphones size={20}/>, bg: "bg-blue-100 text-brand-blue" },
  { id: 3, name: "Ali æ°´ç®¡", lastMsg: "Thank you boss!", time: "10æœˆ5æ—¥", unread: 0, avatar: <Droplet size={20}/>, bg: "bg-blue-100 text-brand-blue" },
];

const chatHistoryMock = [
  { id: 1, sender: "me", text: "å¸ˆå‚…ï¼Œè¯·é—®å¤§æ¦‚è¿˜è¦å¤šä¹…ï¼Ÿ", time: "14:30" },
  { id: 2, sender: "sifu", text: "è€æ¿ä½ å¥½ï¼Œæˆ‘ç°åœ¨åœ¨ Puchong è¿‡æ¥ã€‚", time: "14:31" },
  { id: 3, sender: "sifu", text: "å¤§æ¦‚ 15-20 åˆ†é’Ÿå·¦å³åˆ°ã€‚", time: "14:32" },
  { id: 4, sender: "me", text: "å¥½çš„ï¼Œåˆ°äº†æ‰“ç»™æˆ‘ã€‚", time: "14:32" },
  { id: 5, sender: "sifu", text: "å¥½çš„è€æ¿ï¼Œæˆ‘åˆ°äº†ç»™ä½ ç”µè¯ã€‚", time: "14:35" },
];

const initialAddresses = [
  { id: 1, label: "Home", address: "No. 18, Jalan Indah 3/2, Taman Universiti Indah, 43300 Seri Kembangan", isDefault: true },
  { id: 2, label: "Office", address: "Level 5, Menara 123, Jalan Bukit Bintang, 55100 Kuala Lumpur", isDefault: false },
];

const initialCards = [
  { id: 1, type: "visa", number: "**** **** **** 4242", expiry: "12/26", brand: "Maybank Debit" },
  { id: 2, type: "tng", number: "å·²ç»‘å®š", expiry: "-", brand: "Touch 'n Go" },
];

const sifuStats = { todayEarnings: "180.00", jobsDone: 3, acceptanceRate: "95%" };
const incomingJob = { id: "JOB-999", type: "SOS", category: "çˆ†æ°´ç®¡ / æ¼æ°´", dist: "0.8km", address: "B-12-05, Pangsapuri Indah", price: "RM 80 - RM 120", customer: "Mdm. Lee", customerPhone: "012-*** 9999", time: "ç«‹å³å‡ºå‘" };

// ğŸŸ¢ ä¹‹å‰ç¼ºå¤±çš„å˜é‡ï¼šå¸ˆå‚…ä»»åŠ¡æ•°æ® (Job Management Data)
const sifuSchedule = [
  { id: 101, type: "SOS", status: "active", time: "14:30", customer: "Mdm. Lee", category: "çˆ†æ°´ç®¡ / æ¼æ°´", address: "B-12-05, Pangsapuri Indah", price: "RM 120", date: "Today" },
  { id: 102, type: "Booking", status: "pending", time: "16:00", customer: "Jason Lim", category: "å†·æ°”æ¸…æ´— (2å°)", address: "No. 8, Jalan Kenari, Puchong", price: "RM 200", date: "Today" },
  { id: 103, type: "Booking", status: "completed", time: "10:00", customer: "Ali Ahmad", category: "æ›´æ¢æ’åº§", address: "Taman Equine, Shop Lot 2", price: "RM 80", date: "Today" },
  { id: 104, type: "Booking", status: "pending", time: "09:00", customer: "Sarah Tan", category: "å®‰è£…åŠæ‰‡", address: "Cyberjaya Domain 5", price: "RM 150", date: "Tomorrow" }
];

// ç¤¾åŒºæ•°æ®
const communityPosts = [
  { id: 1, author: "Ah Hock (æ°´ç”µ)", avatar: <Droplet size={16}/>, type: "job_pass", content: "ã€æ‰“å•ã€‘Puchong IOI é™„è¿‘æœ‰ä¸ªä¿®é©¬æ¡¶çš„å•ï¼Œæˆ‘åœ¨ PJ èµ¶ä¸è¿‡å»ï¼Œè°èƒ½æ¥ï¼ŸRm80 ç°ç»“ã€‚", time: "10åˆ†é’Ÿå‰", likes: 2, comments: 5 },
  { id: 2, author: "Sifu Mark (å†·æ°”)", avatar: <Zap size={16}/>, type: "discuss", content: "æœ€è¿‘ Daikin çš„å†·æ°”æœºæœ‰æ²¡æœ‰è§‰å¾—å¾ˆéš¾æ‹†ï¼Ÿå°¤å…¶æ˜¯æ–°æ¬¾çš„ï¼Œå¡æ‰£å¾ˆç´§ã€‚", time: "2å°æ—¶å‰", likes: 12, comments: 8 },
  { id: 3, author: "Uncle Lim (è£…ä¿®)", avatar: <Wrench size={16}/>, type: "promo", content: "æ”¶äºŒæ‰‹ç”µé’»ï¼Œæœ‰çš„ç§ä¿¡æˆ‘ã€‚", time: "5å°æ—¶å‰", likes: 0, comments: 1 },
];

// ç”¨æˆ·éœ€æ±‚å¹¿åœºæ•°æ®
const initialUserRequests = [
  { id: 1, user: "Mdm. Lee", avatar: null, category: "å†·æ°”æœåŠ¡", title: "ä¸¤å° Daikin å†·æ°”ä¸å†·äº†", desc: "å¼€äº†16åº¦è¿˜æ˜¯æ„Ÿè§‰åƒé€é£ï¼Œè€Œä¸”å‡ºé£å£æœ‰ç‚¹æ¼æ°´ï¼Œéœ€è¦æ¸…æ´—å’Œæ£€æŸ¥ gasã€‚", photos: ["https://images.unsplash.com/photo-1545259741-2ea3ebf61fa3?auto=format&fit=crop&w=400&q=80"], dist: "1.2km", address: "Taman Equine, Seri Kembangan", time: "10åˆ†é’Ÿå‰", status: "open", comments: [{ id: 101, sifu: "ç‹å¸ˆå‚…", text: "è€æ¿ï¼Œè¿™ä¸ªæƒ…å†µåº”è¯¥æ˜¯è¦åš Chemical wash äº†ã€‚æ™®é€šæ´— RM100ï¼Œè¯æ°´æ´— RM150ã€‚", time: "5åˆ†é’Ÿå‰", priceOffer: "RM 150" }] },
  { id: 2, user: "Jason Lim", avatar: null, category: "æˆ¿å±‹ä¿®ç¼®", title: "å¨æˆ¿æ´—æ‰‹ç›†ä¸‹é¢æ¼æ°´", desc: "åº”è¯¥æ˜¯æ°´ç®¡è€åŒ–äº†ï¼Œæ•´ä¸ªæŸœå­éƒ½æ¹¿äº†ã€‚éœ€è¦æ¢æ–°çš„æ°´ç®¡ã€‚", photos: ["https://images.unsplash.com/photo-1585704032915-c3400ca199e7?auto=format&fit=crop&w=400&q=80"], dist: "3.5km", address: "Puchong Jaya", time: "2å°æ—¶å‰", status: "open", comments: [] }
];

// ==========================================
// 3. ç»„ä»¶: è®¤è¯å±å¹•
// ==========================================
const AuthScreen = ({ onLogin }) => {
    const [step, setStep] = useState('landing');
    const [role, setRole] = useState('user');
    const [mobile, setMobile] = useState('');

    const handleLogin = () => { onLogin(role); };

    if (step === 'landing') {
        return (
            <div className="flex flex-col h-full bg-brand-blue text-white animate-fade-in relative overflow-hidden md:flex-row">
                <div className="flex-1 flex flex-col items-center justify-center p-8 z-10 md:items-start md:pl-20">
                    <div className="w-24 h-24 bg-white rounded-3xl flex items-center justify-center mb-6 shadow-xl transform rotate-3 text-brand-blue"><Wrench size={48} /></div>
                    <h1 className="text-4xl font-bold mb-2 tracking-tight md:text-6xl">Sifu-Go</h1>
                    <p className="text-blue-100 text-center mb-12 md:text-left md:text-xl">é©¬æ¥è¥¿äºšé¦–é€‰å®¶åº­æœåŠ¡å¹³å°ã€‚<br/>è§£å†³ç”Ÿæ´»çäº‹ï¼Œåªéœ€ä¸€é”®å‘¼å«ã€‚</p>
                    <div className="hidden md:block text-blue-200 text-sm mt-8">ğŸ’» ç½‘é¡µç‰ˆ / ğŸ“± æ‰‹æœº App å…¨å¹³å°æ”¯æŒ</div>
                </div>
                <div className="flex-1 flex flex-col items-center justify-center p-8 bg-white/5 backdrop-blur-sm md:bg-white md:text-gray-800">
                    <div className="w-full max-w-sm space-y-4">
                        <button onClick={() => { setRole('user'); setStep('login'); }} className="w-full bg-white text-brand-blue font-bold py-4 rounded-xl shadow-lg active:scale-95 transition md:bg-brand-blue md:text-white">æˆ‘æ˜¯ç”¨æˆ· (æ‰¾å¸ˆå‚…)</button>
                        <button onClick={() => { setRole('sifu'); setStep('login'); }} className="w-full bg-brand-orange text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2"><Briefcase size={20} /> æˆ‘æ˜¯å¸ˆå‚… (æ¥å•)</button>
                    </div>
                    <div className="p-4 text-center text-xs text-blue-200 md:text-gray-400 mt-4">Version 1.2.0</div>
                </div>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full bg-white animate-slide-up items-center justify-center">
            <div className="w-full max-w-md p-6">
                <button onClick={() => setStep('landing')} className="mb-6 p-2 bg-gray-50 rounded-full hover:bg-gray-100 transition"><ChevronLeft size={28} className="text-gray-800" /></button>
                <h2 className="text-3xl font-bold mb-2">{role === 'user' ? 'æ¬¢è¿å›æ¥' : 'åŠ å…¥ Sifu å›¢é˜Ÿ'}</h2>
                <p className="text-gray-500 mb-8">{role === 'user' ? 'è¾“å…¥æ‰‹æœºå·å¼€å§‹æ‰¾å¸ˆå‚…' : 'æ³¨å†Œæˆä¸ºä¸“ä¸šå¸ˆå‚…ï¼Œå¼€å§‹æ¥å•èµšé’±'}</p>
                <div className="space-y-6">
                    <div>
                        <label className="text-xs font-bold text-gray-400 uppercase">æ‰‹æœºå·ç </label>
                        <div className="flex items-center border-b-2 border-gray-100 py-2 focus-within:border-brand-blue transition"><span className="text-gray-500 font-bold mr-3">+60</span><input type="tel" value={mobile} onChange={(e) => setMobile(e.target.value)} className="flex-1 outline-none text-xl font-bold text-gray-800 placeholder-gray-300" placeholder="12 345 6789" autoFocus /></div>
                    </div>
                    <button onClick={handleLogin} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg transition active:scale-95 ${mobile.length > 8 ? (role === 'user' ? 'bg-brand-blue' : 'bg-gray-900') : 'bg-gray-300 cursor-not-allowed'}`}>{role === 'user' ? 'è·å–éªŒè¯ç ' : 'ä¸‹ä¸€æ­¥: éªŒè¯èº«ä»½'}</button>
                </div>
                {role === 'sifu' && (<div className="mt-8 p-4 bg-gray-50 rounded-xl"><h4 className="font-bold text-sm mb-2">å¸ˆå‚…æ³¨å†Œè¦æ±‚:</h4><ul className="text-xs text-gray-500 space-y-1 list-disc pl-4"><li>é©¬æ¥è¥¿äºšå…¬æ°‘ (IC) æˆ–åˆæ³•å·¥ä½œå‡†è¯</li><li>æ‹¥æœ‰ç›¸å…³æŠ€èƒ½è¯ä¹¦ (å¦‚é€‚ç”¨)</li><li>æ— çŠ¯ç½ªè®°å½•</li></ul></div>)}
            </div>
        </div>
    );
};

// ==========================================
// 4. ç»„ä»¶: å¸ˆå‚…ç«¯ (å®Œæ•´åŠŸèƒ½ç‰ˆ)
// ==========================================
const SifuDashboard = ({ onLogout }) => {
    const [isOnline, setIsOnline] = useState(false);
    const [activeTab, setActiveTab] = useState('home');
    const [showNewJob, setShowNewJob] = useState(false);
    const [activeJob, setActiveJob] = useState(null); 
    const [jobStep, setJobStep] = useState(0); 
    const [showChat, setShowChat] = useState(false); 
	const [jobFilter, setJobFilter] = useState('today');
    
    // éœ€æ±‚å¹¿åœºé€»è¾‘
    const [requestList, setRequestList] = useState(initialUserRequests);
    const [selectedRequest, setSelectedRequest] = useState(null); 
    const [replyText, setReplyText] = useState("");
	
	// ==========================================
	// æ–°å¢: é’±åŒ…æ¨¡æ‹Ÿæ•°æ®
	// ==========================================
	const [showBalance, setShowBalance] = useState(true);
	const [selectedTransaction, setSelectedTransaction] = useState(null); 
	const walletTransactions = [
      { id: 1, type: "income", title: "è®¢å•æ”¶å…¥ - #ORD-8823", date: "2023-10-24 15:30", amount: "RM 120.00", status: "success", ref: "TXN-8823-999", method: "Wallet Balance" },
      { id: 2, type: "income", title: "è®¢å•æ”¶å…¥ - #ORD-8810", date: "2023-10-24 11:00", amount: "RM 80.00", status: "success", ref: "TXN-8810-777", method: "Wallet Balance" },
      { id: 3, type: "withdraw", title: "æç°è‡³ Maybank", date: "2023-10-23 09:15", amount: "RM 500.00", status: "processing", ref: "WDR-9999-111", method: "Maybank (**** 8823)" },
      { id: 4, type: "fee", title: "å¹³å°æœåŠ¡è´¹ (5%)", date: "2023-10-23 09:00", amount: "RM 10.00", status: "success", ref: "FEE-0000-123", method: "System Deduction" },
    ];

	const weeklyEarnings = [40, 80, 20, 150, 100, 200, 120]; // æ¨¡æ‹Ÿä¸€å‘¨æ”¶å…¥æ•°æ®ç”¨äºå›¾è¡¨

    const steps = ["å·²æ¥å•", "å‰å¾€ä¸­", "å·¥ä½œä¸­", "å·²å®Œæˆ"];
	
	// ğŸŸ¢ ä¸ªäººä¸­å¿ƒè®¾ç½®çŠ¶æ€
    const [settingsModal, setSettingsModal] = useState(null); // 'skills', 'area', 'hours'
    const [serviceRange, setServiceRange] = useState(10); // km
    const [mySkills, setMySkills] = useState([
        { id: 1, name: "æ™®é€šå¼€é”", price: "80", active: true },
        { id: 2, name: "æ›´æ¢é”èŠ¯", price: "150", active: true },
        { id: 3, name: "æ±½è½¦å¼€é”", price: "120", active: false },
        { id: 4, name: "ä¿é™©ç®±å¼€é”", price: "250", active: false },
    ]);
    const [workDays, setWorkDays] = useState([
        { day: "å‘¨ä¸€", open: true, start: "09:00", end: "18:00" },
        { day: "å‘¨äºŒ", open: true, start: "09:00", end: "18:00" },
        { day: "å‘¨ä¸‰", open: true, start: "09:00", end: "18:00" },
        { day: "å‘¨å››", open: true, start: "09:00", end: "18:00" },
        { day: "å‘¨äº”", open: true, start: "09:00", end: "18:00" },
        { day: "å‘¨å…­", open: true, start: "10:00", end: "16:00" },
        { day: "å‘¨æ—¥", open: false, start: "09:00", end: "18:00" },
    ]);
	// ğŸŸ¢ è´¦å·å®‰å…¨çŠ¶æ€
    const [bankInfo, setBankInfo] = useState({ bank: "Maybank", account: "1641 9999 8888", holder: "ALEX ONG" });
    const [appSettings, setAppSettings] = useState({ notif: true, sound: true, lang: "ä¸­æ–‡ (ç®€ä½“)" });

    // æ¨¡æ‹ŸSOSæ¨å•
    useEffect(() => {
        if(isOnline && !activeJob) {
            const timer = setTimeout(() => setShowNewJob(true), 5000); 
            return () => clearTimeout(timer);
        } else {
            setShowNewJob(false);
        }
    }, [isOnline, activeJob]);

    const handleAcceptJob = () => { setShowNewJob(false); setActiveJob(incomingJob); setJobStep(1); setActiveTab('home'); };
    const handleJobAction = () => { if (jobStep < 3) { setJobStep(prev => prev + 1); } else { setActiveJob(null); setJobStep(0); alert("è®¢å•å®Œæˆï¼"); } };

    const handlePostComment = () => {
        if(!replyText.trim()) return;
        const newComment = { id: Date.now(), sifu: "æˆ‘ (Alex Ong)", text: replyText, time: "åˆšåˆš", priceOffer: null };
        const updatedRequests = requestList.map(req => req.id === selectedRequest.id ? { ...req, comments: [...req.comments, newComment] } : req);
        setRequestList(updatedRequests);
        setSelectedRequest({ ...selectedRequest, comments: [...selectedRequest.comments, newComment] });
        setReplyText("");
    };
	// --- æ¸²æŸ“å‡½æ•° ---
	
	// ğŸŸ¢ æ–°å¢ï¼šè®¾ç½®å¼¹çª—æ¸²æŸ“å™¨
    const renderSettingsModal = () => {
        if (!settingsModal) return null;

        const renderContent = () => {
            switch(settingsModal) {
                case 'skills':
                    return (
                        <div className="space-y-4">
                            <p className="text-xs text-gray-500 mb-4">å‹¾é€‰æ‚¨æä¾›çš„æœåŠ¡ï¼Œå¹¶è®¾ç½®èµ·æ­¥ä»·ã€‚</p>
                            {mySkills.map((skill, idx) => (
                                <div key={skill.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                                    <div className="flex items-center gap-3">
                                        <div 
                                            onClick={() => {
                                                const newSkills = [...mySkills];
                                                newSkills[idx].active = !newSkills[idx].active;
                                                setMySkills(newSkills);
                                            }}
                                            className={`w-6 h-6 rounded-md flex items-center justify-center cursor-pointer transition ${skill.active ? 'bg-brand-blue text-white' : 'bg-gray-200 text-gray-400'}`}
                                        >
                                            {skill.active && <CheckCircle size={16}/>}
                                        </div>
                                        <span className={`text-sm font-bold ${skill.active ? 'text-gray-800' : 'text-gray-400'}`}>{skill.name}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-400">RM</span>
                                        <input 
                                            type="number" 
                                            value={skill.price} 
                                            disabled={!skill.active}
                                            onChange={(e) => {
                                                const newSkills = [...mySkills];
                                                newSkills[idx].price = e.target.value;
                                                setMySkills(newSkills);
                                            }}
                                            className="w-16 bg-white border border-gray-200 rounded-lg px-2 py-1 text-sm font-bold text-right focus:outline-none focus:border-brand-blue"
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                case 'area':
                    return (
                        <div className="py-6">
                            <div className="flex justify-between items-center mb-8">
                                <span className="text-sm font-bold text-gray-500">å½“å‰èŒƒå›´</span>
                                <span className="text-3xl font-bold text-brand-orange">{serviceRange} km</span>
                            </div>
                            <input 
                                type="range" 
                                min="1" 
                                max="50" 
                                value={serviceRange} 
                                onChange={(e) => setServiceRange(e.target.value)}
                                className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-brand-blue"
                            />
                            <div className="flex justify-between text-xs text-gray-400 mt-2">
                                <span>1km</span>
                                <span>50km</span>
                            </div>
                            <div className="mt-8 bg-blue-50 p-4 rounded-xl flex items-start gap-3">
                                <MapPin size={20} className="text-brand-blue flex-shrink-0 mt-0.5"/>
                                <p className="text-xs text-blue-600 leading-relaxed">
                                    æ¥å•èŒƒå›´åŸºäºæ‚¨å½“å‰çš„ GPS ä½ç½®ã€‚å¦‚æœç§»åŠ¨è¶…è¿‡ 500ç±³ï¼Œæ¥å•ä¸­å¿ƒä¼šè‡ªåŠ¨æ›´æ–°ã€‚
                                </p>
                            </div>
                        </div>
                    );
                case 'hours':
                    return (
                        <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-1">
                            {workDays.map((d, idx) => (
                                <div key={idx} className={`p-3 rounded-xl border flex items-center justify-between ${d.open ? 'bg-white border-gray-200' : 'bg-gray-50 border-transparent'}`}>
                                    <div className="flex items-center gap-3">
                                        <div 
                                            onClick={() => {
                                                const newDays = [...workDays];
                                                newDays[idx].open = !newDays[idx].open;
                                                setWorkDays(newDays);
                                            }}
                                            className={`w-10 h-6 rounded-full p-1 cursor-pointer transition-colors ${d.open ? 'bg-green-500' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform ${d.open ? 'translate-x-4' : ''}`}></div>
                                        </div>
                                        <span className={`text-sm font-bold ${d.open ? 'text-gray-800' : 'text-gray-400'}`}>{d.day}</span>
                                    </div>
                                    {d.open ? (
                                        <div className="flex items-center gap-2">
                                            <input type="time" value={d.start} className="bg-gray-100 rounded px-2 py-1 text-xs font-bold text-gray-700 outline-none" onChange={(e) => {
                                                const newDays = [...workDays]; newDays[idx].start = e.target.value; setWorkDays(newDays);
                                            }}/>
                                            <span className="text-gray-300">-</span>
                                            <input type="time" value={d.end} className="bg-gray-100 rounded px-2 py-1 text-xs font-bold text-gray-700 outline-none" onChange={(e) => {
                                                const newDays = [...workDays]; newDays[idx].end = e.target.value; setWorkDays(newDays);
                                            }}/>
                                        </div>
                                    ) : (
                                        <span className="text-xs text-gray-400 font-medium px-4">ä¼‘æ¯</span>
                                    )}
                                </div>
                            ))}
                        </div>
                    );
				case 'bank':
                    return (
                        <div className="space-y-6">
                            {/* Bank Card Preview */}
                            <div className="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 text-white shadow-lg relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                                <div className="flex justify-between items-start mb-6"><span className="text-xs opacity-70">BANK CARD</span><span className="font-bold tracking-widest">{bankInfo.bank}</span></div>
                                <div className="text-xl font-mono tracking-widest mb-4">{bankInfo.account}</div>
                                <div className="text-xs opacity-70 uppercase">{bankInfo.holder}</div>
                            </div>
                            {/* Inputs */}
                            <div className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-400 mb-1 block">é“¶è¡Œåç§°</label><select className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-brand-blue" value={bankInfo.bank} onChange={e => setBankInfo({...bankInfo, bank: e.target.value})}><option>Maybank</option><option>Public Bank</option><option>CIMB Bank</option><option>Hong Leong Bank</option></select></div>
                                <div><label className="text-xs font-bold text-gray-400 mb-1 block">é“¶è¡Œè´¦å·</label><input type="text" className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-brand-blue" value={bankInfo.account} onChange={e => setBankInfo({...bankInfo, account: e.target.value})}/></div>
                                <div><label className="text-xs font-bold text-gray-400 mb-1 block">æŒå¡äººå§“å</label><input type="text" className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-brand-blue" value={bankInfo.holder} onChange={e => setBankInfo({...bankInfo, holder: e.target.value})}/></div>
                            </div>
                        </div>
                    );
                case 'identity':
                    return (
                        <div className="space-y-6 text-center">
                            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto"><Shield size={40} className="text-green-500"/></div>
                            <div><h3 className="text-lg font-bold text-green-600">å·²é€šè¿‡å®åè®¤è¯</h3><p className="text-xs text-gray-400 mt-1">æ‚¨çš„èº«ä»½ä¿¡æ¯å·²æ ¸éªŒï¼Œå¯æ­£å¸¸æ¥å•ã€‚</p></div>
                            <div className="bg-gray-50 p-4 rounded-xl text-left border border-gray-100">
                                <div className="flex justify-between mb-2"><span className="text-xs text-gray-400">çœŸå®å§“å</span><span className="text-sm font-bold text-gray-800">Alex Ong</span></div>
                                <div className="flex justify-between"><span className="text-xs text-gray-400">èº«ä»½è¯å·</span><span className="text-sm font-bold text-gray-800">880101-10-****</span></div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="aspect-video bg-gray-200 rounded-lg flex items-center justify-center relative overflow-hidden"><Image size={24} className="text-gray-400"/><div className="absolute inset-0 bg-black/5 flex items-center justify-center"><span className="text-[10px] font-bold text-gray-500 bg-white/80 px-2 py-1 rounded">IC æ­£é¢</span></div></div>
                                <div className="aspect-video bg-gray-200 rounded-lg flex items-center justify-center relative overflow-hidden"><Image size={24} className="text-gray-400"/><div className="absolute inset-0 bg-black/5 flex items-center justify-center"><span className="text-[10px] font-bold text-gray-500 bg-white/80 px-2 py-1 rounded">IC åé¢</span></div></div>
                            </div>
                            <p className="text-[10px] text-gray-400">å¦‚éœ€ä¿®æ”¹è®¤è¯ä¿¡æ¯ï¼Œè¯·è”ç³»äººå·¥å®¢æœã€‚</p>
                        </div>
                    );
                case 'app_settings':
                    return (
                        <div className="space-y-2">
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center"><MessageCircle size={16}/></div><span className="text-sm font-bold text-gray-700">æ¨é€é€šçŸ¥</span></div>
                                <div onClick={() => setAppSettings({...appSettings, notif: !appSettings.notif})} className={`w-10 h-6 rounded-full p-1 cursor-pointer transition-colors ${appSettings.notif ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform ${appSettings.notif ? 'translate-x-4' : ''}`}></div></div>
                            </div>
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-orange-100 text-brand-orange flex items-center justify-center"><Headphones size={16}/></div><span className="text-sm font-bold text-gray-700">æ¥å•æç¤ºéŸ³</span></div>
                                <div onClick={() => setAppSettings({...appSettings, sound: !appSettings.sound})} className={`w-10 h-6 rounded-full p-1 cursor-pointer transition-colors ${appSettings.sound ? 'bg-green-500' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform ${appSettings.sound ? 'translate-x-4' : ''}`}></div></div>
                            </div>
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl cursor-pointer active:bg-gray-100 transition">
                                <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center"><Globe size={16}/></div><span className="text-sm font-bold text-gray-700">è¯­è¨€è®¾ç½®</span></div>
                                <div className="flex items-center gap-2"><span className="text-xs text-gray-500">{appSettings.lang}</span><ChevronRight size={16} className="text-gray-400"/></div>
                            </div>
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl cursor-pointer active:bg-gray-100 transition">
                                <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center"><Lock size={16}/></div><span className="text-sm font-bold text-gray-700">ä¿®æ”¹å¯†ç </span></div>
                                <ChevronRight size={16} className="text-gray-400"/>
                            </div>
                        </div>
                    );
                default:
                    return null;
            }
        };

        const titles = {
            skills: "æŠ€èƒ½ä¸æŠ¥ä»·",
            area: "æœåŠ¡èŒƒå›´",
            hours: "å·¥ä½œæ—¶é—´",
			bank: "æ”¶æ¬¾é“¶è¡Œå¡",
            identity: "å®åè®¤è¯",
            app_settings: "App è®¾ç½®"
        };

        return (
            <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-end md:items-center md:justify-center animate-fade-in">
                <div onClick={(e) => e.stopPropagation()} className="bg-white w-full md:w-[450px] md:rounded-2xl rounded-t-3xl p-6 animate-slide-up relative">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-bold text-gray-800">{titles[settingsModal]}</h3>
                        <button onClick={() => setSettingsModal(null)} className="p-1 bg-gray-100 rounded-full hover:bg-gray-200"><X size={20} className="text-gray-600"/></button>
                    </div>
                    {renderContent()}
                    <div className="mt-8 pt-4 border-t border-gray-100">
                         {settingsModal !== 'identity' && (
                            <button onClick={() => setSettingsModal(null)} className="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition">ä¿å­˜è®¾ç½®</button>
                        )}
                        {settingsModal === 'identity' && (
                             <button onClick={() => setSettingsModal(null)} className="w-full bg-gray-100 text-gray-600 font-bold py-3.5 rounded-xl">å…³é—­</button>
                        )}
                    </div>
                </div>
            </div>
        );
    };
	
	// ğŸŸ¢ äº¤æ˜“è¯¦æƒ…å¼¹çª— (Receipt Style)
    const renderTransactionDetailModal = () => {
        if (!selectedTransaction) return null;
        const isIncome = selectedTransaction.type === 'income';
        const isWithdraw = selectedTransaction.type === 'withdraw';
        
        return (
            <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in">
                <div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-scale-up relative">
                    {/* Header Background */}
                    <div className={`h-24 w-full absolute top-0 left-0 ${isIncome ? 'bg-green-500' : isWithdraw ? 'bg-blue-500' : 'bg-red-500'}`}></div>
                    
                    <button onClick={() => setSelectedTransaction(null)} className="absolute top-4 right-4 bg-black/20 hover:bg-black/30 text-white p-2 rounded-full z-20 transition"><X size={20}/></button>

                    <div className="relative z-10 px-6 pt-12 text-center pb-8">
                        {/* Status Icon */}
                        <div className="w-20 h-20 bg-white rounded-full mx-auto flex items-center justify-center shadow-lg mb-4">
                            {isIncome ? <ArrowRight size={40} className="text-green-500 rotate-45" /> : 
                             isWithdraw ? <Wallet size={36} className="text-blue-500" /> : 
                             <AlertTriangle size={36} className="text-red-500" />}
                        </div>

                        <h2 className={`text-3xl font-bold mb-1 ${isIncome ? 'text-green-600' : isWithdraw ? 'text-gray-800' : 'text-red-600'}`}>
                            {isIncome ? '+' : '-'}{selectedTransaction.amount}
                        </h2>
                        <span className={`inline-block px-3 py-1 rounded-full text-xs font-bold uppercase mb-6 ${
                            selectedTransaction.status === 'success' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'
                        }`}>
                            {selectedTransaction.status === 'success' ? 'äº¤æ˜“æˆåŠŸ' : 'å¤„ç†ä¸­...'}
                        </span>

                        {/* Details List */}
                        <div className="bg-gray-50 rounded-xl p-4 text-left space-y-4 text-sm border border-gray-100">
                            <div className="flex justify-between">
                                <span className="text-gray-400">äº¤æ˜“å†…å®¹</span>
                                <span className="font-bold text-gray-800 text-right w-1/2 break-words">{selectedTransaction.title}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">æ—¶é—´</span>
                                <span className="font-bold text-gray-800">{selectedTransaction.date}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">æ”¯ä»˜æ–¹å¼</span>
                                <span className="font-bold text-gray-800">{selectedTransaction.method}</span>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-gray-400">äº¤æ˜“å•å·</span>
                                <span className="font-mono text-xs text-gray-600 bg-gray-200 px-2 py-1 rounded select-all">{selectedTransaction.ref}</span>
                            </div>
                        </div>

                        {/* Footer Action */}
                        <div className="mt-8">
                             <button onClick={() => setSelectedTransaction(null)} className="w-full py-3.5 bg-gray-900 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-gray-800 transition">
                                 å…³é—­
                             </button>
                             <button className="mt-3 text-xs text-gray-400 hover:text-gray-600">å¯¹æ­¤è®¢å•æœ‰ç–‘é—®ï¼Ÿè”ç³»å®¢æœ</button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };
	// 1. é’±åŒ…è§†å›¾ğŸ’°
    const renderWalletView = () => {
        return (
            <div className="flex flex-col h-full bg-gray-900 text-white animate-slide-up">
                {/* é¡¶éƒ¨å¡ç‰‡åŒº */}
                <div className="p-6 pt-12 pb-4">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">æˆ‘çš„é’±åŒ…</h2>
                        <button className="p-2 bg-gray-800 rounded-full hover:bg-gray-700"><Settings size={20} className="text-gray-400"/></button>
                    </div>

                    {/* èµ„äº§å¡ç‰‡ */}
                    <div className="bg-gradient-to-br from-brand-blue to-purple-600 rounded-2xl p-6 shadow-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <div className="absolute bottom-0 left-0 w-24 h-24 bg-brand-orange/20 rounded-full blur-2xl -ml-10 -mb-10"></div>
                        
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-2">
                                <span className="text-blue-100 text-xs font-bold uppercase tracking-widest">Available Balance</span>
                                <CreditCard className="text-white/50" size={24}/>
                            </div>
                            <div className="flex items-center gap-3 mb-6">
                                <h1 className="text-4xl font-bold tracking-tight">
                                    {showBalance ? "RM 1,250.00" : "*******"}
                                </h1>
                                <button onClick={() => setShowBalance(!showBalance)}>
                                    {showBalance ? <Eye size={20} className="text-blue-200"/> : <EyeOff size={20} className="text-blue-200"/>}
                                </button>
                            </div>
                            <div className="flex gap-3">
                                <button className="flex-1 bg-white text-brand-blue py-2.5 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                    <ArrowRight size={16} className="-rotate-45"/> æç°
                                </button>
                                <button className="flex-1 bg-brand-blue border border-white/30 text-white py-2.5 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                    <Plus size={16}/> å……å€¼
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* ç®€å•çš„æ”¶å…¥å›¾è¡¨ (CSS Bar Chart) */}
                    {/* æœ¬å‘¨æ”¶å…¥æ¦‚è§ˆ (ä¿®æ”¹å¤„ï¼šå¤§æ•°å­—æ›¿ä»£å›¾è¡¨) */}
                    <div className="mt-4 bg-gray-800 p-4 rounded-2xl border border-gray-700 flex justify-between items-center shadow-md">
                        <div>
                            <p className="text-gray-400 text-xs mb-1 font-medium">æœ¬å‘¨æ€»æ”¶å…¥</p>
                            <h3 className="text-3xl font-bold text-white tracking-tight">RM 710.00</h3>
                        </div>
                        <div className="text-right">
                            <div className="bg-green-500/10 text-green-400 px-2 py-1 rounded-lg text-xs font-bold inline-flex items-center gap-1 mb-1 border border-green-500/20">
                                <ArrowUpRight size={14}/> +12%
                            </div>
                            <p className="text-[10px] text-gray-500">å¯¹æ¯”ä¸Šå‘¨ RM 630</p>
                        </div>
                    </div>
                </div>

                {/* äº¤æ˜“è®°å½•åˆ—è¡¨ */}
				<div className="h-full overflow-auto">
					<div className="flex-1 bg-gray-800 rounded-t-3xl p-6 overflow-hidden flex flex-col">
						<h3 className="font-bold text-white mb-4">äº¤æ˜“è®°å½•</h3>
						<div className="flex-1 overflow-y-auto space-y-4 pr-1 ">
							{walletTransactions.map((t) => (
								<div key={t.id} onClick={() => setSelectedTransaction(t)} className="flex items-center justify-between group p-2 rounded-lg hover:bg-gray-700/50 transition cursor-pointer active:scale-95">
									<div className="flex items-center gap-3">
										<div className={`w-10 h-10 rounded-full flex items-center justify-center ${
											t.type === 'income' ? 'bg-green-500/20 text-green-500' : 
											t.type === 'withdraw' ? 'bg-blue-500/20 text-blue-500' : 'bg-red-500/20 text-red-500'
										}`}>
											{t.type === 'income' ? <ArrowRight size={18} className="rotate-45"/> : 
											 t.type === 'withdraw' ? <Wallet size={18}/> : <AlertTriangle size={18}/>}
										</div>
										<div>
											<h4 className="text-sm font-bold text-gray-200 group-hover:text-white transition">{t.title}</h4>
											<p className="text-xs text-gray-500">{t.date}</p>
										</div>
									</div>
									<div className="text-right">
										<div className={`font-bold ${
											t.type === 'income' ? 'text-green-400' : 'text-white'
										}`}>{t.amount}</div>
										<div className={`text-[10px] ${
											t.status === 'success' ? 'text-gray-500' : 'text-yellow-500'
										}`}>{t.status === 'success' ? 'æˆåŠŸ' : 'å¤„ç†ä¸­'}</div>
									</div>
								</div>
							))}
							<div className="pt-4 text-center">
								<button className="text-xs text-gray-500 hover:text-white transition">æŸ¥çœ‹å…¨éƒ¨å†å²è®°å½•</button>
							</div>
						</div>
					</div>
                </div>
            </div>
        );
    };

    // æ¸²æŸ“ï¼šéœ€æ±‚è¯¦æƒ…å¼¹çª—
    const renderRequestDetailModal = () => (
        <div className="fixed inset-0 z-[60] bg-white flex flex-col animate-slide-up md:absolute md:inset-0">
            <div className="bg-white p-4 pt-8 border-b border-gray-100 shadow-sm flex items-center gap-3 sticky top-0 z-10">
                <button onClick={() => setSelectedRequest(null)} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100 transition"><ChevronLeft size={20}/></button>
                <div className="flex-1"><h2 className="font-bold text-gray-800 text-lg">éœ€æ±‚è¯¦æƒ…</h2></div>
            </div>
            <div className="flex-1 overflow-y-auto p-4 pb-24">
                <div className="flex items-center gap-3 mb-4"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-brand-blue font-bold">{selectedRequest.user[0]}</div><div><h3 className="font-bold text-gray-800">{selectedRequest.user}</h3><p className="text-xs text-gray-500">{selectedRequest.time} â€¢ {selectedRequest.dist}</p></div></div>
                <h2 className="text-xl font-bold text-gray-900 mb-2">{selectedRequest.title}</h2>
                <div className="flex items-center gap-2 mb-4"><span className="bg-brand-orange/10 text-brand-orange text-xs font-bold px-2 py-1 rounded">{selectedRequest.category}</span><span className="text-xs text-gray-400"><MapPin size={10} className="inline"/> {selectedRequest.address}</span></div>
                <p className="text-gray-600 text-sm leading-relaxed mb-4">{selectedRequest.desc}</p>
                {selectedRequest.photos && selectedRequest.photos.length > 0 && (<div className="grid grid-cols-2 gap-2 mb-6">{selectedRequest.photos.map((img, i) => <img key={i} src={img} className="rounded-xl w-full h-32 object-cover shadow-sm border border-gray-100" />)}</div>)}
                <div className="border-t border-gray-100 pt-4">
                    <h4 className="font-bold text-sm text-gray-700 mb-4">ç•™è¨€æ²Ÿé€š / æŠ¥ä»· ({selectedRequest.comments.length})</h4>
                    <div className="space-y-4">{selectedRequest.comments.map(c => (<div key={c.id} className="flex gap-3"><div className="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0"></div><div className="bg-gray-50 p-3 rounded-xl rounded-tl-none flex-1"><div className="flex justify-between items-baseline mb-1"><span className="text-xs font-bold text-gray-800">{c.sifu}</span><span className="text-[10px] text-gray-400">{c.time}</span></div><p className="text-sm text-gray-600">{c.text}</p>{c.priceOffer && <div className="mt-2 text-brand-blue font-bold text-sm">æŠ¥ä»·: {c.priceOffer}</div>}</div></div>))}</div>
                </div>
            </div>
            <div className="p-4 bg-white border-t border-gray-100 pb-8"><div className="flex gap-2"><input type="text" value={replyText} onChange={e => setReplyText(e.target.value)} placeholder="è¯¢é—®è¯¦æƒ…æˆ–ç›´æ¥æŠ¥ä»·..." className="flex-1 bg-gray-100 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-brand-blue border border-transparent"/><button onClick={handlePostComment} className="bg-brand-blue text-white px-4 rounded-xl font-bold text-sm">å‘é€</button></div></div>
        </div>
    );

    // æ¸²æŸ“ï¼šè¿›è¡Œä¸­çš„è®¢å•
    const renderActiveJobView = () => (
        <div className="flex flex-col h-full bg-gray-50 animate-slide-up relative">
            <div className="h-2/5 w-full relative bg-gray-200"><iframe width="100%" height="100%" frameBorder="0" scrolling="no" src="https://www.openstreetmap.org/export/embed.html?bbox=101.68685913085939%2C3.006931201367338%2C101.72668457031251%2C3.033504907992788&amp;layer=mapnik" className="w-full h-full opacity-80 mix-blend-multiply"></iframe><div className="absolute top-4 left-4 bg-white/90 backdrop-blur-sm p-2 rounded-xl shadow-lg border border-white/20"><div className="flex items-center gap-2"><Navigation size={16} className="text-blue-500" /><span className="text-xs font-bold text-gray-800">è·ç¦» 0.8km</span></div></div></div>
            {/* ä¿®å¤ï¼šå¢åŠ  pb-24ï¼Œé˜²æ­¢åº•éƒ¨æŒ‰é’®è¢«é®æŒ¡ */}
            <div className="flex-1 bg-white -mt-6 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] relative z-10 flex flex-col p-6 pb-24 overflow-y-auto">
                <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <div className="flex justify-between mb-8 relative px-2">
                    {/* ä¿®å¤ï¼šè¿›åº¦çº¿æ¡ä½ç½® top-3 */}
                    <div className="absolute top-3 left-0 w-full h-1 bg-gray-100 -mt-0.5 z-0"></div>
                    <div className={`absolute top-3 left-0 h-1 bg-green-500 -mt-0.5 z-0 transition-all duration-500`} style={{ width: `${(jobStep / 3) * 100}%` }}></div>
                    {steps.map((s, i) => (<div key={i} className="relative z-10 flex flex-col items-center gap-1"><div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 text-[10px] font-bold transition-colors ${i <= jobStep ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-gray-300 text-gray-400'}`}>{i < jobStep ? <CheckCircle size={12}/> : i + 1}</div><span className={`text-[10px] font-bold ${i <= jobStep ? 'text-green-600' : 'text-gray-300'}`}>{s}</span></div>))}
                </div>
                <div className="flex items-center gap-4 mb-6"><div className="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center text-brand-blue font-bold text-xl border-2 border-white shadow-md">L</div><div className="flex-1"><h2 className="text-xl font-bold text-gray-800">{activeJob.customer}</h2><div className="flex items-center gap-2 text-sm text-gray-500"><Star size={14} className="text-yellow-400 fill-current"/> 4.8 (12 å•)</div></div><button className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200"><Phone size={20}/></button></div>
                <div className="space-y-4 mb-8"><div className="flex gap-3 items-start p-3 bg-gray-50 rounded-xl"><MapPin size={20} className="text-gray-400 mt-0.5 flex-shrink-0" /><div><h4 className="font-bold text-sm text-gray-800">æœåŠ¡åœ°å€</h4><p className="text-sm text-gray-600 leading-relaxed">{activeJob.address}</p></div></div><div className="flex gap-3 items-start p-3 bg-orange-50 rounded-xl"><Zap size={20} className="text-brand-orange mt-0.5 flex-shrink-0" /><div><h4 className="font-bold text-sm text-gray-800">æœåŠ¡å†…å®¹</h4><p className="text-sm text-gray-600">{activeJob.category}</p></div></div></div>
                <div className="mt-auto"><button onClick={handleJobAction} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition active:scale-95 ${jobStep === 3 ? 'bg-gray-800' : 'bg-brand-blue'}`}>{jobStep === 1 && <><Navigation size={20}/> æˆ‘å·²åˆ°è¾¾</>}{jobStep === 2 && <><Wrench size={20}/> å¼€å§‹å·¥ä½œ</>}{jobStep === 3 && <><CheckCircle size={20}/> å®Œæˆè®¢å•</>}</button>{jobStep < 3 && <button onClick={() => {if(confirm("ç¡®å®šå–æ¶ˆè®¢å•å—ï¼Ÿä¼šå½±å“ä¿¡èª‰åˆ†ã€‚")) {setActiveJob(null); setJobStep(0);}}} className="w-full mt-3 py-3 text-red-400 font-bold text-sm">å–æ¶ˆè®¢å•</button>}</div>
            </div>
            <button onClick={() => setShowChat(true)} className="absolute bottom-28 right-6 w-14 h-14 bg-green-500 text-white rounded-full shadow-2xl flex items-center justify-center z-20 hover:scale-110 transition active:scale-95 animate-bounce-subtle"><MessageCircle size={28} /><span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-[10px] font-bold flex items-center justify-center border-2 border-white">1</span></button>
            {showChat && (<div className="absolute inset-0 z-50 bg-white flex flex-col animate-slide-up"><div className="p-4 bg-white border-b border-gray-100 flex justify-between items-center shadow-sm"><div className="flex items-center gap-3"><button onClick={() => setShowChat(false)} className="text-gray-900"><ChevronLeft size={24}/></button><h3 className="font-bold text-gray-800">{activeJob.customer}</h3></div><Phone size={20} className="text-gray-400"/></div><div className="flex-1 bg-gray-50 p-4 overflow-y-auto"><div className="flex justify-start mb-4"><div className="bg-white p-3 rounded-xl rounded-tl-none shadow-sm text-sm text-gray-700 max-w-[80%]">å¸ˆå‚…ï¼Œå¤§æ¦‚è¿˜è¦å¤šä¹…åˆ°ï¼Ÿæˆ‘å®¶æ°´ç®¡æ¼å¾—å¾ˆå‰å®³ã€‚</div></div><div className="flex justify-end mb-4"><div className="bg-brand-blue p-3 rounded-xl rounded-tr-none shadow-md text-sm text-white max-w-[80%]">æˆ‘å·²ç»åœ¨æ¥¼ä¸‹äº†ï¼Œæ­£åœ¨æ‰¾åœè½¦ä½ï¼Œé©¬ä¸Šä¸Šæ¥ï¼</div></div></div><div className="p-4 pb-24 md:pb-4 bg-white border-t border-gray-100 flex gap-2"><input type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none"/><button className="p-2 bg-brand-blue text-white rounded-full"><Send size={18}/></button></div></div>)}
        </div>
    );

    const renderCommunityView = () => (
        <div className="flex flex-col h-full bg-gray-100 animate-slide-up">
            <div className="bg-white p-6 sticky top-0 z-10 border-b border-gray-200 shadow-sm"><h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Users className="text-brand-orange"/> å¸ˆå‚…ç¤¾åŒº</h2><div className="flex gap-2 overflow-x-auto no-scrollbar">{['å…¨éƒ¨', 'æ‰“å•/è½¬å•', 'æŠ€æœ¯äº¤æµ', 'é—²èŠ'].map((t, i) => (<button key={i} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition ${i === 0 ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{t}</button>))}</div></div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-3 mb-2"><div className="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0"></div><div className="flex-1"><div className="bg-gray-50 rounded-xl p-3 text-sm text-gray-400 mb-2">åˆ†äº«ä½ çš„ç»éªŒï¼Œæˆ–è€…å‘ä¸ªæ‰“å•è´´...</div><div className="flex justify-between items-center"><div className="flex gap-3 text-gray-400"><Camera size={18}/><MapPin size={18}/></div><button className="bg-brand-blue text-white px-4 py-1.5 rounded-lg text-xs font-bold">å‘å¸ƒ</button></div></div></div>
                {communityPosts.map(post => (
                    <div key={post.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div className="flex justify-between items-start mb-3"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-blue-50 text-brand-blue rounded-full flex items-center justify-center border border-blue-100">{post.avatar}</div><div><h4 className="font-bold text-sm text-gray-800">{post.author}</h4><p className="text-[10px] text-gray-400">{post.time}</p></div></div><button className="text-gray-300"><MoreVertical size={16}/></button></div><div className="mb-4">{post.type === 'job_pass' && <span className="bg-red-100 text-red-500 text-[10px] font-bold px-1.5 py-0.5 rounded mr-2 align-middle">æ€¥å•</span>}<p className="text-sm text-gray-700 leading-relaxed">{post.content}</p></div><div className="flex items-center justify-between pt-3 border-t border-gray-50"><button className="flex items-center gap-1 text-xs text-gray-400 hover:text-brand-blue"><ThumbsUp size={14}/> {post.likes}</button><button className="flex items-center gap-1 text-xs text-gray-400 hover:text-brand-blue"><MessageSquare size={14}/> {post.comments}</button><button className="flex items-center gap-1 text-xs text-gray-400 hover:text-brand-blue"><Share2 size={14}/> åˆ†äº«</button></div></div>
                ))}
            </div>
            <button className="absolute bottom-24 right-6 w-12 h-12 bg-brand-orange text-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition active:scale-95"><Plus size={24}/></button>
        </div>
    );

    const renderJobsView = () => {
        const dates = [{ day: "å‘¨äº”", date: "02", label: "Today", active: true }, { day: "å‘¨å…­", date: "03", label: "Tomorrow", active: false }, { day: "å‘¨æ—¥", date: "04", label: "Sun", active: false }, { day: "å‘¨ä¸€", date: "05", label: "Mon", active: false }, { day: "å‘¨äºŒ", date: "06", label: "Tue", active: false }];
        return (
            <div className="flex flex-col h-full bg-gray-50 animate-slide-up">
                <div className="bg-gray-800 p-6 pt-12 pb-8 rounded-b-3xl shadow-lg z-10"><div className="flex justify-between items-end mb-4"><div><h2 className="text-2xl font-bold text-white mb-1">ä»»åŠ¡ç®¡ç†</h2><p className="text-gray-400 text-xs">ä»Šæ—¥å®‰æ’ â€¢ 3 ä¸ªä»»åŠ¡</p></div><div className="text-right"><p className="text-gray-400 text-[10px] uppercase tracking-wider">é¢„è®¡æ”¶å…¥</p><p className="text-xl font-bold text-green-400">RM 400.00</p></div></div><div className="flex justify-between gap-2 overflow-x-auto no-scrollbar pt-2">{dates.map((d, i) => (<div key={i} className={`flex flex-col items-center justify-center min-w-[60px] h-16 rounded-xl border transition cursor-pointer ${d.active ? 'bg-brand-orange border-brand-orange text-white shadow-lg scale-105' : 'bg-gray-700/50 border-gray-600 text-gray-400'}`}><span className="text-[10px] font-medium">{d.day}</span><span className="text-lg font-bold">{d.date}</span></div>))}</div></div>
                <div className="px-4 mt-4"><div className="bg-white p-1 rounded-xl shadow-sm flex">{['è¿›è¡Œä¸­/å¾…åŠ', 'å†å²è®¢å•'].map((f) => (<button key={f} onClick={() => setJobFilter(f === 'å†å²è®¢å•' ? 'history' : 'today')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition ${(jobFilter === 'today' && f.includes('è¿›è¡Œä¸­')) || (jobFilter === 'history' && f.includes('å†å²')) ? 'bg-gray-800 text-white shadow' : 'text-gray-500 hover:bg-gray-50'}`}>{f}</button>))}</div></div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                    {sifuSchedule.filter(job => jobFilter === 'history' ? job.status === 'completed' : job.status !== 'completed').map((job) => (<div key={job.id} className={`relative bg-white p-0 rounded-2xl shadow-sm border border-gray-100 overflow-hidden group transition active:scale-95 ${job.type === 'SOS' && job.status === 'active' ? 'ring-2 ring-red-500/20' : ''}`}><div className={`absolute left-0 top-0 bottom-0 w-1.5 ${job.status === 'completed' ? 'bg-green-500' : job.status === 'active' ? 'bg-blue-500' : job.type === 'SOS' ? 'bg-red-500' : 'bg-yellow-400'}`}></div><div className="p-4 pl-6 flex gap-4"><div className="flex flex-col items-center pt-1 min-w-[50px]"><span className="text-lg font-bold text-gray-800 leading-none">{job.time}</span><span className="text-[10px] text-gray-400 mt-1 uppercase">{job.date === 'Today' ? 'ä»Šå¤©' : 'æ˜å¤©'}</span>{job.status === 'completed' && <div className="mt-2 text-green-500"><CheckCircle size={16}/></div>}</div><div className="flex-1 border-l border-gray-100 pl-4"><div className="flex justify-between items-start mb-1"><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${job.type === 'SOS' ? 'bg-red-100 text-red-600' : 'bg-blue-50 text-brand-blue'}`}>{job.type === 'SOS' ? 'âš¡ ç´§æ€¥æ•‘æ´' : 'ğŸ“… é¢„çº¦æœåŠ¡'}</span><span className="font-bold text-gray-800">{job.price}</span></div><h3 className="font-bold text-gray-800 text-md mb-0.5">{job.category}</h3><div className="flex items-center gap-1 text-xs text-gray-500 mb-2"><User size={12}/> {job.customer}</div><div className="flex items-start gap-1 text-xs text-gray-400 leading-snug"><MapPin size={12} className="mt-0.5 flex-shrink-0"/> {job.address}</div></div></div>{job.status !== 'completed' && (<div className="bg-gray-50 p-2 flex border-t border-gray-100"><button className="flex-1 flex items-center justify-center gap-2 py-2 text-xs font-bold text-gray-600 hover:bg-white rounded-lg transition"><Phone size={14}/> è”ç³»</button><div className="w-px bg-gray-200 my-1"></div><button className="flex-1 flex items-center justify-center gap-2 py-2 text-xs font-bold text-gray-600 hover:bg-white rounded-lg transition"><Navigation size={14}/> å¯¼èˆª</button>{job.status === 'active' ? (<button onClick={() => setActiveTab('home')} className="flex-1 ml-2 bg-brand-blue text-white rounded-lg text-xs font-bold shadow-md">ç»§ç»­å·¥ä½œ</button>) : (<button className="flex-1 ml-2 bg-gray-800 text-white rounded-lg text-xs font-bold shadow-md">å¼€å§‹æ¥å•</button>)}</div>)}</div>))}
                    {sifuSchedule.filter(job => jobFilter === 'history' ? job.status === 'completed' : job.status !== 'completed').length === 0 && (<div className="flex flex-col items-center justify-center h-48 text-gray-400"><Clock size={40} className="mb-2 opacity-20"/><p className="text-sm">æš‚æ— ç›¸å…³ä»»åŠ¡</p></div>)}
                </div>
            </div>
        );
    };
	
	// 5. ä¸ªäººä¸­å¿ƒè§†å›¾ (Profile & Settings)
    const renderProfileView = () => {
        return (
            <div className="flex flex-col h-full bg-gray-900 text-white animate-slide-up">
                {/* Header Profile Card */}
                <div className="p-6 pt-12 pb-8 bg-gray-800 rounded-b-3xl shadow-lg z-10">
                    <div className="flex items-start gap-4 mb-6">
                        <div className="relative">
                            <div className="w-20 h-20 rounded-full border-4 border-gray-700 overflow-hidden">
                                <img src="https://i.pravatar.cc/150?img=11" className="w-full h-full object-cover" />
                            </div>
                            <div className="absolute -bottom-2 -right-2 bg-brand-blue text-white text-[10px] px-2 py-1 rounded-full border-2 border-gray-800 font-bold flex items-center gap-1">
                                <Shield size={10} fill="currentColor"/> å·²è®¤è¯
                            </div>
                        </div>
                        <div className="flex-1">
                            <h2 className="text-2xl font-bold">Alex Ong</h2>
                            <p className="text-gray-400 text-sm mb-2">ID: 882394 â€¢ åŠ å…¥äº 2021</p>
                            <div className="flex gap-2">
                                <span className="bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded text-xs font-bold border border-yellow-500/30 flex items-center gap-1"><Award size={12}/> é‡‘ç‰Œå¸ˆå‚…</span>
                                <span className="bg-green-500/20 text-green-500 px-2 py-0.5 rounded text-xs font-bold border border-green-500/30">æ¥å•åˆ† 100</span>
                            </div>
                        </div>
                    </div>

                    {/* Level Progress */}
                    <div className="bg-gray-700/50 p-4 rounded-xl border border-gray-600">
                        <div className="flex justify-between text-xs mb-2">
                            <span className="text-gray-300">è·ç¦» <span className="text-white font-bold">é’»çŸ³å¸ˆå‚…</span> è¿˜å·® 12 å•</span>
                            <span className="text-brand-orange font-bold">88%</span>
                        </div>
                        <div className="w-full h-2 bg-gray-600 rounded-full overflow-hidden">
                            <div className="h-full bg-gradient-to-r from-yellow-500 to-brand-orange w-[88%]"></div>
                        </div>
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-24">
                    {/* Performance Stats */}
                    <div className="grid grid-cols-3 gap-2">
                        <div className="bg-gray-800 p-3 rounded-xl border border-gray-700 text-center">
                            <div className="text-yellow-400 font-bold text-xl flex items-center justify-center gap-1">4.9 <Star size={14} fill="currentColor"/></div>
                            <div className="text-[10px] text-gray-500 mt-1">ç»¼åˆè¯„åˆ†</div>
                        </div>
                        <div className="bg-gray-800 p-3 rounded-xl border border-gray-700 text-center">
                            <div className="text-white font-bold text-xl">100%</div>
                            <div className="text-[10px] text-gray-500 mt-1">å‡†æ—¶ç‡</div>
                        </div>
                        <div className="bg-gray-800 p-3 rounded-xl border border-gray-700 text-center">
                            <div className="text-white font-bold text-xl">328</div>
                            <div className="text-[10px] text-gray-500 mt-1">æ€»æœåŠ¡å•</div>
                        </div>
                    </div>

                    {/* Settings Lists */}
                    <div className="space-y-3">
                        <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">æœåŠ¡ç®¡ç†</h3>
                        <div className="bg-gray-800 rounded-2xl overflow-hidden border border-gray-700">
                            {[
                                { id: 'skills', l: "æœåŠ¡æŠ€èƒ½ä¸æŠ¥ä»·", i: <Wrench size={18} className="text-blue-400"/>, d: "ä¿®æ”¹å®šä»· / æ·»åŠ æŠ€èƒ½" },
                                { id: 'area', l: "æœåŠ¡èŒƒå›´è®¾ç½®", i: <MapPin size={18} className="text-green-400"/>, d: `å½“å‰: ${serviceRange}km` },
                                { id: 'hours', l: "å·¥ä½œæ—¶é—´", i: <Clock size={18} className="text-orange-400"/>, d: "æ¯å¤© 9:00 - 18:00" },
                            ].map((item, idx) => (
                                <div key={idx} onClick={() => setSettingsModal(item.id)} className="flex items-center p-4 border-b border-gray-700 last:border-0 hover:bg-gray-750 active:bg-gray-700 transition cursor-pointer">
                                    <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-3">{item.i}</div>
                                    <div className="flex-1">
                                        <div className="text-sm font-bold text-gray-200">{item.l}</div>
                                        <div className="text-xs text-gray-500">{item.d}</div>
                                    </div>
                                    <ChevronRight size={16} className="text-gray-500"/>
                                </div>
                            ))}
                        </div>

                        <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1 mt-6">è´¦å·ä¸å®‰å…¨</h3>
                        <div className="bg-gray-800 rounded-2xl overflow-hidden border border-gray-700">
                             {[
                                { id: 'bank', l: "æ”¶æ¬¾é“¶è¡Œå¡", i: <CreditCard size={18} className="text-purple-400"/>, d: "Maybank **** 8823" },
                                { id: 'identity', l: "å®åè®¤è¯ä¿¡æ¯", i: <FileText size={18} className="text-gray-400"/>, d: "å·²é€šè¿‡" },
                                { id: 'app_settings', l: "App è®¾ç½®", i: <Settings size={18} className="text-gray-400"/>, d: "è¯­è¨€ / é€šçŸ¥" },
                            ].map((item, idx) => (
                                <div key={idx} onClick={() => setSettingsModal(item.id)} className="flex items-center p-4 border-b border-gray-700 last:border-0 hover:bg-gray-750 active:bg-gray-700 transition cursor-pointer">
                                    <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center mr-3">{item.i}</div>
                                    <div className="flex-1">
                                        <div className="text-sm font-bold text-gray-200">{item.l}</div>
                                        <div className="text-xs text-gray-500">{item.d}</div>
                                    </div>
                                    <ChevronRight size={16} className="text-gray-500"/>
                                </div>
                            ))}
                        </div>
                    </div>

                    <button onClick={onLogout} className="w-full py-4 rounded-xl border border-red-900/50 text-red-500 font-bold text-sm hover:bg-red-900/20 transition flex items-center justify-center gap-2">
                        <LogOut size={18}/> é€€å‡ºç™»å½•
                    </button>
                    <div className="text-center text-[10px] text-gray-600 pb-4">
                        Sifu-Go Partner v1.2.0
                    </div>
                </div>
            </div>
        );
    };
	

    return (
        <div className="flex flex-col h-full bg-gray-900 text-white animate-fade-in relative md:flex-row w-full">
            {/* Desktop Nav */}
            <div className="hidden md:flex flex-col w-64 bg-gray-800 border-r border-gray-700 p-6">
                <h1 className="text-2xl font-bold mb-8 flex items-center gap-2"><Briefcase className="text-brand-orange"/> Sifu Pro</h1>
                <div className="space-y-2 flex-1">
                    {[{ id: 'home', l: 'æ¥å•å°', i: <Briefcase size={20} /> }, { id: 'jobs', l: 'ä»»åŠ¡ç®¡ç†', i: <Clock size={20} /> }, { id: 'community', l: 'å¸ˆå‚…ç¤¾åŒº', i: <Users size={20} /> }, { id: 'wallet', l: 'æˆ‘çš„é’±åŒ…', i: <Wallet size={20} /> }, { id: 'profile', l: 'ä¸ªäººä¸­å¿ƒ', i: <User size={20} /> }].map(n => (<button key={n.id} onClick={() => setActiveTab(n.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${activeTab === n.id ? 'bg-brand-orange text-white' : 'text-gray-400 hover:bg-gray-700'}`}>{n.i} <span>{n.l}</span></button>))}
                </div>
                <button onClick={onLogout} className="flex items-center gap-2 text-gray-500 hover:text-white mt-auto"><LogOut size={18}/> é€€å‡ºç™»å½•</button>
            </div>

            {/* Main Content */}
            <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                {activeTab === 'community' && renderCommunityView()}
                {activeTab === 'jobs' && renderJobsView()} {/* âœ… ä¿®å¤äº†è¿™é‡Œï¼ */}
                {activeTab === 'home' && activeJob && renderActiveJobView()}
				{activeTab === 'wallet' && renderWalletView()}
				{activeTab === 'profile' && renderProfileView()}
                
                {/* å¸ˆå‚…æ§åˆ¶å°é¦–é¡µ (æ— è¿›è¡Œä¸­è®¢å•æ—¶æ˜¾ç¤º) */}
                {activeTab === 'home' && !activeJob && (
                    <>
                        <div className="md:hidden p-6 pt-12 flex justify-between items-center bg-gray-800 rounded-b-3xl shadow-lg z-10">
                            <div className="flex items-center gap-3"><div className="w-12 h-12 bg-gray-700 rounded-full border-2 border-green-500 overflow-hidden"><img src="https://i.pravatar.cc/150?img=11" className="w-full h-full object-cover"/></div><div><h2 className="font-bold text-lg">Alex Ong</h2><div className="text-xs text-green-400">â­ 4.9</div></div></div>
                            <button onClick={() => setIsOnline(!isOnline)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold transition-all shadow-lg ${isOnline ? 'bg-green-500 text-white' : 'bg-gray-700 text-gray-400'}`}><Power size={18} /> {isOnline ? 'On' : 'Off'}</button>
                        </div>
                        <div className="hidden md:flex justify-between items-center p-6 bg-gray-800 border-b border-gray-700"><h2 className="text-xl font-bold">æ§åˆ¶å°</h2><div className="flex items-center gap-6"><button onClick={() => setIsOnline(!isOnline)} className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold transition-all ${isOnline ? 'bg-green-500 text-white' : 'bg-gray-700 text-gray-400'}`}><Power size={18} /> {isOnline ? 'æ¥å•æ¨¡å¼: å¼€å¯' : 'æ¥å•æ¨¡å¼: å…³é—­'}</button><div className="flex items-center gap-3"><span className="text-right"><div className="font-bold">Alex Ong</div><div className="text-xs text-gray-400">ID: 8823</div></span><img src="https://i.pravatar.cc/150?img=11" className="w-10 h-10 rounded-full bg-gray-700"/></div></div></div>

                        <div className="flex-1 overflow-y-auto p-4 pb-24 md:p-8">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div className="bg-gray-800 p-4 rounded-2xl border border-gray-700"><div className="text-gray-400 text-xs mb-1">ä»Šæ—¥æ”¶å…¥</div><div className="text-2xl font-bold text-white">RM 180.00</div></div><div className="bg-gray-800 p-4 rounded-2xl border border-gray-700"><div className="text-gray-400 text-xs mb-1">æ¥å•ç‡</div><div className="text-2xl font-bold text-green-400">95%</div></div></div>
                            {showNewJob && (
                                <div className="max-w-md mx-auto w-full bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-3xl p-1 shadow-2xl animate-scale-up mb-8">
                                    <div className="bg-gray-800 rounded-[20px] p-5">
                                        <div className="w-full h-1 bg-gray-700 rounded-full mb-4 overflow-hidden"><div className="h-full bg-brand-orange w-3/4 animate-pulse"></div></div>
                                        <div className="flex justify-between items-start mb-4"><div><span className="bg-red-500/20 text-red-500 text-[10px] font-bold px-2 py-1 rounded mb-2 inline-block animate-pulse">ç´§æ€¥ SOS</span><h2 className="text-2xl font-bold text-white">çˆ†æ°´ç®¡ / æ¼æ°´</h2><p className="text-gray-400 text-sm mt-1 flex items-center gap-1"><MapPin size={14}/> 0.8km â€¢ Pangsapuri Indah</p></div><div className="w-12 h-12 bg-gray-700 rounded-xl flex items-center justify-center"><Droplet size={24} className="text-blue-400"/></div></div>
                                        <div className="grid grid-cols-2 gap-3"><button onClick={() => setShowNewJob(false)} className="py-3.5 rounded-xl bg-gray-700 font-bold text-gray-300">å¿½ç•¥</button><button onClick={handleAcceptJob} className="py-3.5 rounded-xl bg-green-500 font-bold text-white shadow-lg">ç«‹å³æ¥å•</button></div>
                                    </div>
                                </div>
                            )}
                            <div>
                                <h3 className="text-gray-400 font-bold mb-4 flex items-center gap-2"><Globe size={16}/> é™„è¿‘éœ€æ±‚å¹¿åœº (Job Feed)</h3>
                                <div className="space-y-4">
                                    {requestList.map(req => (
                                        <div key={req.id} onClick={() => setSelectedRequest(req)} className="bg-gray-800 p-4 rounded-xl border border-gray-700 cursor-pointer hover:border-gray-600 transition">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-3"><div className="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-sm font-bold text-gray-300">{req.user[0]}</div><div><h4 className="font-bold text-white text-sm">{req.user}</h4><p className="text-[10px] text-gray-400">{req.time} â€¢ {req.dist}</p></div></div>
                                                <span className="bg-blue-900/50 text-blue-300 px-2 py-1 rounded text-[10px] font-bold border border-blue-800">{req.category}</span>
                                            </div>
                                            <h4 className="font-bold text-gray-200 mb-1">{req.title}</h4>
                                            <p className="text-sm text-gray-400 line-clamp-2 mb-3">{req.desc}</p>
                                            {req.photos && req.photos.length > 0 && (<div className="flex gap-2 mb-3">{req.photos.map((p, idx) => <div key={idx} className="w-16 h-16 rounded-lg bg-gray-700 bg-cover bg-center" style={{backgroundImage: `url(${p})`}}></div>)}</div>)}
                                            <div className="flex items-center justify-between border-t border-gray-700 pt-3"><span className="text-xs text-gray-500 flex items-center gap-1"><MapPin size={12}/> {req.address}</span><div className="flex items-center gap-1 text-xs text-brand-orange font-bold"><MessageSquare size={14}/> {req.comments.length} ç•™è¨€æŠ¥ä»·</div></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </>
                )}
                {activeTab !== 'home' && activeTab !== 'community' && activeTab !== 'jobs' && activeTab !== 'wallet' && activeTab !== 'profile' && (<div className="flex items-center justify-center h-full text-gray-500">å¼€å‘ä¸­...</div>)}				
                {selectedRequest && renderRequestDetailModal()}
				{renderTransactionDetailModal()}
				{renderSettingsModal()} {/* âœ… æ¸²æŸ“ä¸ªäººä¸­å¿ƒè®¾ç½®å¼¹çª— */}
				
                <div className="md:hidden absolute bottom-0 w-full bg-gray-800 border-t border-gray-700 py-3 px-6 flex justify-between items-center z-20">
                    {[{ id: 'home', l: 'æ¥å•', i: <Briefcase size={22} /> }, { id: 'jobs', l: 'ä»»åŠ¡', i: <Clock size={22} /> }, { id: 'community', l: 'ç¤¾åŒº', i: <Users size={22} /> }, { id: 'wallet', l: 'é’±åŒ…', i: <Wallet size={22} /> }, { id: 'profile', l: 'æˆ‘çš„', i: <User size={22} /> }].map(n => (
                        <div key={n.id} onClick={() => setActiveTab(n.id)} className={`flex flex-col items-center cursor-pointer ${activeTab === n.id ? 'text-brand-orange' : 'text-gray-500'}`}>
                            {n.i}<span className="text-[10px] font-medium mt-1">{n.l}</span>
                        </div>
                    ))}
                </div>
            </div>
				
        </div>
    );
};

// ==========================================
// 5. ä¸»ç»„ä»¶: App (ç”¨æˆ·ç«¯æ›´æ–°)
// ==========================================
const App = () => {
	// --- ğŸŸ¢ æ–°å¢ï¼šå¼ºåˆ¶ç¦æ­¢ç¼©æ”¾é€»è¾‘ (Anti-Zoom Logic) ---
    useEffect(() => {
        // 1. ç¦æ­¢åŒæŒ‡æåˆç¼©æ”¾ (Pinch to Zoom)
        const handleTouchMove = (e) => {
            if (e.touches.length > 1) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„åŒæŒ‡ç¼©æ”¾
            }
        };

        // 2. ç¦æ­¢åŒå‡»ç¼©æ”¾ (Double Tap to Zoom)
        let lastTouchEnd = 0;
        const handleTouchEnd = (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault(); // å¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”å°äº300msï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ”¾å¤§ï¼‰
            }
            lastTouchEnd = now;
        };

        // æ·»åŠ ç›‘å¬å™¨ (æ³¨æ„ passive: false æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™æ— æ³•æ‹¦æˆª)
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd, { passive: false });

        return () => {
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
        };
    }, []);
    // ... (ä¿ç•™ä¹‹å‰çš„ state) ...
    // æ ¸å¿ƒ
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [userRole, setUserRole] = useState('user');
    const [activeTab, setActiveTab] = useState('find');
    const [lang, setLang] = useState('zh');
    const t = (key) => translations[lang][key] || key;

    // UI
    const [selectedSifu, setSelectedSifu] = useState(null);
    const [activeChat, setActiveChat] = useState(null);
    const [showMoreMenu, setShowMoreMenu] = useState(false);
    const [showVoucherRules, setShowVoucherRules] = useState(false);
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [userProfile, setUserProfile] = useState({ name: "Alex Tan", phone: "012-345 6789", avatar: null });

    // Modals
    const [modals, setModals] = useState({
        profile: false, topup: false, withdraw: false,
        address: false, addAddress: false,
        payment: false, addCard: false,
        language: false, help: false, logout: false,
        postRequest: false, // æ–°å¢ï¼šå‘å¸ƒéœ€æ±‚å¼¹çª—
    });
    const toggleModal = (key, value) => setModals(prev => ({ ...prev, [key]: value }));

    // æ–°å¢ï¼šè®¢å• Tab çŠ¶æ€ (orders vs requests)
    const [orderTab, setOrderTab] = useState('active'); // active, history, requests
    const [myRequests, setMyRequests] = useState(initialUserRequests); // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    const [newRequest, setNewRequest] = useState({ cat: "æˆ¿å±‹ä¿®ç¼®", title: "", desc: "" });

    // ... (ä¿ç•™ Data, SOS state, Handlers ç­‰) ...
    // Data
    const [addressList, setAddressList] = useState(initialAddresses);
    const [cardList, setCardList] = useState(initialCards);
    const [expandedFaq, setExpandedFaq] = useState(null);
    const fileInputRef = useRef(null);
    const [newAddr, setNewAddr] = useState({ label: "Home", detail: "" });
    const [newCard, setNewCard] = useState({ no: "", expiry: "", cvv: "" });

    // SOS
    const [sosState, setSosState] = useState('idle');
    const [sosType, setSosType] = useState(null);
    const [sosLocation, setSosLocation] = useState({ id: 'gps', label: 'GPS å®šä½', address: 'Seri Kembangan' });
    const [customSosText, setCustomSosText] = useState("");
    const [tempNewAddress, setTempNewAddress] = useState("");

    // Slider
    const sliderRef = useRef(null);
    const [isDown, setIsDown] = useState(false);
    const [startX, setStartX] = useState(0);
    const [scrollLeft, setScrollLeft] = useState(0);
    const handleMouseDown = (e) => { setIsDown(true); setStartX(e.pageX - sliderRef.current.offsetLeft); setScrollLeft(sliderRef.current.scrollLeft); };
    const handleMouseLeave = () => setIsDown(false);
    const handleMouseUp = () => setIsDown(false);
    const handleMouseMove = (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - sliderRef.current.offsetLeft; const walk = (x - startX) * 2; sliderRef.current.scrollLeft = scrollLeft - walk; };

    // Handlers
    const handleLoginSuccess = (role) => { setUserRole(role); setIsLoggedIn(true); };
    const handleLogout = () => { setIsLoggedIn(false); setUserRole('user'); setActiveTab('find'); toggleModal('logout', false); };
    const handleCategoryClick = (categoryType, categoryLabel) => { setSelectedCategory({ type: categoryType, label: categoryLabel }); setShowMoreMenu(false); };
    const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) setUserProfile(prev => ({ ...prev, avatar: URL.createObjectURL(file) })); };
    const handleSetDefaultAddress = (id) => { setAddressList(prev => prev.map(addr => ({ ...addr, isDefault: addr.id === id }))); };
    const handleAddAddress = () => { if (!newAddr.detail) return alert("è¯·è¾“å…¥è¯¦ç»†åœ°å€"); setAddressList([...addressList, { id: addressList.length + 1, label: newAddr.label, address: newAddr.detail, isDefault: false }]); setNewAddr({ label: "Home", detail: "" }); toggleModal('addAddress', false); };
    const handleDeleteAddress = (id, e) => { e.stopPropagation(); if (window.confirm(t('confirm_delete_addr'))) { setAddressList(prev => prev.filter(addr => addr.id !== id)); } };
    const handleAddCard = () => { if (!newCard.no) return alert("è¯·è¾“å…¥å¡å·"); setCardList([...cardList, { id: cardList.length + 1, type: "visa", number: `**** ${newCard.no.slice(-4)}`, expiry: newCard.expiry || "12/28", brand: "New Card" }]); setNewCard({ no: "", expiry: "", cvv: "" }); toggleModal('addCard', false); };

    // SOS Logic
    const closeSOS = () => { setSosState('idle'); setSosType(null); };
    const handleSOSClick = () => setSosState('select');
    const handleSelectSOSLocation = (addr) => { setSosLocation(addr); setSosState('select'); };
    const handleAddNewSOSLocation = () => { if(!tempNewAddress) return; const newAddr = { id: Date.now(), label: 'New', address: tempNewAddress, isDefault: false }; setAddressList([...addressList, newAddr]); setSosLocation(newAddr); setTempNewAddress(""); setSosState('select'); };
    const handleSOSSelect = (type) => { setSosType(type); setSosState('scanning'); setTimeout(() => setSosState('failed'), 3000); };
    const handleCustomSOSSubmit = () => { if(!customSosText) return; setSosType('custom'); setSosState('scanning'); setTimeout(() => setSosState('failed'), 3000); };
    const handleExpandSearch = () => { setSosState('scanning_wide'); setTimeout(() => setSosState('found'), 3000); };

    // æ–°å¢ï¼šæäº¤éœ€æ±‚é€»è¾‘
    const handleSubmitRequest = () => {
        if(!newRequest.title || !newRequest.desc) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        const req = {
            id: Date.now(),
            user: "Alex Tan",
            avatar: userProfile.avatar,
            category: newRequest.cat,
            title: newRequest.title,
            desc: newRequest.desc,
            photos: [],
            dist: "0.0km",
            address: "Current Location",
            time: "åˆšåˆš",
            status: "open",
            comments: []
        };
        setMyRequests([req, ...myRequests]);
        toggleModal('postRequest', false);
        setNewRequest({ cat: "æˆ¿å±‹ä¿®ç¼®", title: "", desc: "" });
        setActiveTab('orders');
        setOrderTab('requests'); // è·³è½¬åˆ°éœ€æ±‚åˆ—è¡¨
    };


    // -------------------------------------------
    // Render
    // -------------------------------------------
    if (!isLoggedIn) {
        return (
            <div className="flex flex-col h-[100dvh] bg-gray-50 font-sans mx-auto shadow-2xl overflow-hidden relative border-x border-gray-200 w-full md:border-none">
                <AuthScreen onLogin={handleLoginSuccess} />
            </div>
        );
    }

    if (userRole === 'sifu') {
        return (
            <div className="flex flex-col h-[100dvh] bg-gray-50 font-sans mx-auto shadow-2xl overflow-hidden relative border-x border-gray-200 w-full md:border-none">
                <SifuDashboard onLogout={handleLogout} />
            </div>
        );
    }
    
    // ... (ä¿ç•™ SOS Modal renderSOSModal) ...
    // SOS Modal (Responsive & Fixed & RESTORED VISUALS)
    const renderSOSModal = () => {
        if (sosState === 'idle') return null;
        return (
            <div className="fixed inset-0 z-[100] bg-gray-900/95 backdrop-blur-sm flex flex-col items-center justify-center text-white animate-fade-in">
                {(sosState !== 'scanning' && sosState !== 'scanning_wide' && sosState !== 'select' && sosState !== 'custom_input') && (
                  <button onClick={closeSOS} className="absolute top-6 right-6 p-2 bg-white/10 rounded-full z-20 hover:bg-white/20 transition"><X size={24} /></button>
                )}

                {/* é˜¶æ®µ 0: é€‰åœ°å€ */}
                {sosState === 'location' && (
                    <div className="w-full h-full max-w-md mx-auto flex flex-col p-6 pt-12 animate-slide-up bg-gray-900 md:rounded-2xl md:h-auto md:max-h-[600px] md:shadow-2xl">
                        <div className="flex items-center gap-3 mb-6 relative"><button onClick={() => setSosState('select')}><ChevronLeft size={24} /></button><h3 className="font-bold text-xl">ç¡®è®¤æ•‘æ´åœ°ç‚¹</h3></div>
                        <div className="space-y-4 flex-1 overflow-y-auto">
                            <div onClick={() => handleSelectSOSLocation({ id: 'gps', label: 'GPS å®šä½', address: 'Seri Kembangan' })} className="bg-white/10 p-4 rounded-xl flex items-center gap-3 cursor-pointer border border-brand-blue/50"><MapPin size={20} className="text-brand-blue"/><div><h4 className="font-bold text-sm">å½“å‰ä½ç½® (GPS)</h4></div></div>
                            <div className="border-t border-gray-700 my-2"></div>
                            {addressList.map(addr => (<div key={addr.id} onClick={() => handleSelectSOSLocation(addr)} className="bg-white/5 p-4 rounded-xl flex items-center gap-3 cursor-pointer"><MapPin size={20} className="text-gray-400"/><div className="flex-1 min-w-0"><h4 className="font-bold text-sm truncate">{addr.label}</h4><p className="text-xs text-gray-400 truncate">{addr.address}</p></div></div>))}
                        </div>
                        <div className="mt-4"><div className="flex gap-2"><input type="text" value={tempNewAddress} onChange={e => setTempNewAddress(e.target.value)} placeholder="è¾“å…¥æ–°åœ°å€..." className="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm text-white"/><button onClick={handleAddNewSOSLocation} className="bg-brand-blue px-4 rounded-xl font-bold whitespace-nowrap">ä¿å­˜</button></div></div>
                    </div>
                )}

                {/* é˜¶æ®µ 1: é€‰ç±»å‹ */}
                {sosState === 'select' && (
                  <div className="w-full px-6 animate-scale-up flex flex-col h-full justify-center relative max-w-md mx-auto">
                    <div className="absolute top-6 left-0 right-0 px-6 flex items-center gap-3 z-20">
                        <div onClick={() => setSosState('location')} className="flex-1 min-w-0 bg-white/10 backdrop-blur-md rounded-full py-2 px-4 flex items-center justify-between cursor-pointer border border-white/10 h-12">
                            <div className="flex items-center gap-3 overflow-hidden mr-2 flex-1 min-w-0"><MapPin size={16} className="text-brand-orange flex-shrink-0" /><div className="flex flex-col overflow-hidden min-w-0 flex-1"><span className="text-[10px] text-gray-400 font-bold leading-none mb-0.5 uppercase truncate">{sosLocation.label}</span><span className="text-xs font-bold leading-none truncate block w-full">{sosLocation.address}</span></div></div><ChevronDown size={16} className="text-gray-400 flex-shrink-0" />
                        </div>
                        <button onClick={closeSOS} className="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 border border-white/5 transition flex-shrink-0"><X size={24} /></button>
                    </div>
                    <div className="flex flex-col items-center mb-6 mt-20"><div className="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mb-3 animate-pulse"><AlertTriangle size={32} className="text-white" /></div><h2 className="text-2xl font-bold text-center">ç´§æ€¥å‘¼å« (SOS)</h2><p className="text-gray-300 text-center text-xs mt-1">ç‚¹å‡»ä¸‹æ–¹ç±»å‹ï¼Œç«‹åˆ»å‘¼å«é™„è¿‘çš„å¸ˆå‚…</p></div>
                    <div className="grid grid-cols-1 gap-3 overflow-y-auto max-h-[60vh] pb-4 no-scrollbar">
                      <button onClick={() => handleSOSSelect('water')} className="bg-white/10 hover:bg-white/20 border border-white/10 p-3.5 rounded-2xl flex items-center gap-4 transition active:scale-95"><div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0"><Droplet size={20} /></div><div className="text-left"><h3 className="font-bold text-md">çˆ†æ°´ç®¡ / æ¼æ°´</h3><p className="text-xs text-gray-300">Water Leakage</p></div></button>
                      <button onClick={() => handleSOSSelect('power')} className="bg-white/10 hover:bg-white/20 border border-white/10 p-3.5 rounded-2xl flex items-center gap-4 transition active:scale-95"><div className="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center flex-shrink-0"><Zap size={20} /></div><div className="text-left"><h3 className="font-bold text-md">è·³ç”µ / èµ°ç«</h3><p className="text-xs text-gray-300">Power Failure</p></div></button>
                      <button onClick={() => handleSOSSelect('lock')} className="bg-white/10 hover:bg-white/20 border border-white/10 p-3.5 rounded-2xl flex items-center gap-4 transition active:scale-95"><div className="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0"><Key size={20} /></div><div className="text-left"><h3 className="font-bold text-md">è¢«é”é—¨å¤–</h3><p className="text-xs text-gray-300">Locked Out</p></div></button>
                      <button onClick={() => { setCustomSosText(""); setSosState('custom_input'); }} className="bg-transparent hover:bg-white/5 border-2 border-dashed border-gray-600 p-3.5 rounded-2xl flex items-center gap-4 transition active:scale-95 group"><div className="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-gray-300 group-hover:bg-gray-600 transition flex-shrink-0"><Plus size={20} /></div><div className="text-left"><h3 className="font-bold text-md text-gray-300 group-hover:text-white">å…¶ä»–ç´§æ€¥æƒ…å†µ</h3><p className="text-xs text-gray-500 group-hover:text-gray-400">Other Emergency</p></div></button>
                    </div>
                  </div>
                )}

                {/* é˜¶æ®µ 2: è‡ªå®šä¹‰è¾“å…¥ */}
                {sosState === 'custom_input' && (
                    <div className="w-full h-full max-w-md mx-auto flex flex-col p-6 pt-12 animate-slide-up bg-gray-900 md:rounded-2xl md:h-auto md:shadow-2xl">
                        <div className="flex items-center gap-3 mb-6"><button onClick={() => setSosState('select')}><ChevronLeft size={24} /></button><h3 className="font-bold text-xl">ä»€ä¹ˆç´§æ€¥æƒ…å†µï¼Ÿ</h3></div>
                        <div className="flex-1 flex flex-col">
                            <label className="text-sm text-gray-400 mb-2">è¯·ç®€çŸ­æè¿°ï¼ŒSifu ä¼šç«‹åˆ»çœ‹åˆ°ï¼š</label>
                            <textarea autoFocus value={customSosText} onChange={(e) => setCustomSosText(e.target.value)} placeholder="ä¾‹å¦‚: å®¶é‡Œè¿›è›‡äº†ã€å¤©èŠ±æ¿å¡Œä¸‹æ¥..." className="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-lg text-white focus:outline-none focus:border-brand-orange resize-none h-40 mb-6"></textarea>
                            <button onClick={handleCustomSOSSubmit} disabled={!customSosText.trim()} className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition ${customSosText.trim() ? 'bg-red-600 text-white active:scale-95' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}`}><Zap size={20} fill="currentColor" /> ç«‹å³å‘¼å« Sifu</button>
                        </div>
                    </div>
                )}

                {/* é˜¶æ®µ 3: æ‰«æä¸­ / å¤±è´¥ / æˆåŠŸ */}
                {(sosState === 'scanning' || sosState === 'scanning_wide') && (
                  <div className="flex flex-col items-center text-center px-8">
                    <div className="relative w-48 h-48 mb-8 flex items-center justify-center"><div className={`absolute w-full h-full ${sosState === 'scanning_wide' ? 'bg-orange-500/20' : 'bg-red-500/20'} rounded-full animate-ping`}></div><div className={`absolute w-32 h-32 ${sosState === 'scanning_wide' ? 'bg-orange-500/40' : 'bg-red-500/40'} rounded-full animate-pulse`}></div><div className={`relative w-24 h-24 ${sosState === 'scanning_wide' ? 'bg-orange-600 border-orange-400' : 'bg-red-600 border-red-400'} rounded-full flex items-center justify-center shadow-2xl border-4`}><Search size={40} className="text-white animate-spin-slow" /></div></div>
                    <h2 className="text-2xl font-bold mb-2">{sosState === 'scanning_wide' ? 'æ­£åœ¨æ‰©å¤§èŒƒå›´æœç´¢...' : 'æ­£åœ¨æœå¯»é™„è¿‘çš„ Sifu...'}</h2>
                    <p className="text-gray-300 text-sm">{sosType === 'custom' ? `éœ€æ±‚: ${customSosText}` : (sosState === 'scanning_wide' ? 'å·²é€šçŸ¥ 10km å†…çš„æ‰€æœ‰å¸ˆå‚…' : 'å·²é€šçŸ¥ 3km å†…çš„ç©ºé—²å¸ˆå‚…')}<br/>è¯·ä¿æŒç”µè¯ç•…é€š</p>
                  </div>
                )}
                
                {sosState === 'failed' && (
                  <div className="w-full px-8 text-center animate-shake max-w-md">
                      <div className="w-20 h-20 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-6"><Search size={32} className="text-gray-400" /></div>
                      <h2 className="text-xl font-bold mb-2">é™„è¿‘æš‚æ—¶æ²¡æœ‰ç©ºé—²å¸ˆå‚…</h2>
                      <p className="text-sm text-gray-400 mb-8">åˆšæ‰æœç´¢äº† 3km èŒƒå›´ã€‚å»ºè®®æ‚¨æ‰©å¤§æœç´¢èŒƒå›´ï¼Œæˆ–è”ç³»äººå·¥å®¢æœã€‚</p>
                      <div className="space-y-3"><button onClick={handleExpandSearch} className="w-full bg-brand-orange text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition"><Globe size={18} /> æ‰©å¤§æœç´¢ (10km)</button><button className="w-full bg-white text-gray-900 py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition"><Headphones size={18} /> è”ç³»äººå·¥å®¢æœ</button></div>
                  </div>
                )}
                
                {sosState === 'found' && (
                  <div className="bg-white text-gray-800 w-10/12 max-w-sm rounded-3xl p-6 text-center animate-scale-up shadow-2xl">
                      <div className="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4"><CheckCircle size={32} /></div>
                      <h2 className="text-xl font-bold mb-2">å·²æ¥å•ï¼</h2>
                      <p className="text-sm text-gray-500 mb-6">ç‹å¸ˆå‚…æ­£åœ¨å‰å¾€ï¼š<br/><span className="font-bold text-gray-800">{sosLocation.address}</span></p>
                      <div className="bg-gray-50 rounded-xl p-3 flex items-center gap-3 mb-6 text-left"><div className="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center"><User size={20}/></div><div><div className="font-bold text-sm">ç‹å¸ˆå‚…</div><div className="text-xs text-brand-orange font-bold">{sosType === 'custom' ? `æœåŠ¡: ${customSosText}` : 'æœåŠ¡: ç´§æ€¥ç»´ä¿®'}</div></div><button className="ml-auto p-2 bg-green-500 text-white rounded-full"><Phone size={18}/></button></div>
                      <button onClick={() => { closeSOS(); setActiveTab('orders'); }} className="w-full bg-brand-blue text-white font-bold py-3 rounded-xl shadow-lg">æŸ¥çœ‹è®¢å•è¯¦æƒ…</button>
                  </div>
                )}
            </div>
        );
    };

    // User Content
    const renderContent = () => {
        if (activeTab === 'find') {
            return (
                <div className="flex flex-col h-full bg-gray-50 animate-slide-up">
                    <div className="bg-brand-blue px-4 pt-8 pb-6 shadow-md z-10 rounded-b-3xl md:rounded-none md:px-8">
                        <div className="flex items-center text-white mb-4 max-w-4xl mx-auto w-full"><MapPin className="w-5 h-5 mr-1" /><span className="font-bold text-lg">Seri Kembangan</span><span className="ml-auto text-xs bg-white/20 px-2 py-1 rounded-lg backdrop-blur-sm border border-white/30">{t('nearby')}</span></div>
                        <div className="relative max-w-4xl mx-auto w-full"><input type="text" placeholder={t('search_placeholder')} className="w-full bg-white text-gray-800 py-3 pl-10 pr-4 rounded-xl text-sm shadow-lg focus:outline-none"/><Search className="w-4 h-4 text-gray-400 absolute left-3 top-3.5" /></div>
                    </div>
                    <div className="flex-1 overflow-y-auto pb-24 pt-4 no-scrollbar">
                        <div className="max-w-4xl mx-auto w-full px-4">
                            <div className="hidden md:flex justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm"><div><h2 className="text-2xl font-bold text-gray-800">æ¬¢è¿ä½¿ç”¨ç½‘é¡µç‰ˆ</h2><p className="text-gray-500">æ›´å¤§çš„å±å¹•ï¼Œæ›´æ¸…æ™°çš„æœåŠ¡å±•ç¤ºã€‚</p></div><Laptop size={64} className="text-brand-blue opacity-20"/></div>
                            <div className="mx-0 mb-6 bg-gray-100 rounded-2xl shadow-inner h-40 relative overflow-hidden border border-gray-200 z-0"><iframe width="100%" height="100%" frameBorder="0" scrolling="no" marginHeight="0" marginWidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=101.68685913085939%2C3.006931201367338%2C101.72668457031251%2C3.033504907992788&amp;layer=mapnik" className="w-full h-full opacity-80 mix-blend-multiply"></iframe><div className="absolute inset-0 bg-transparent pointer-events-none shadow-[inset_0_0_20px_rgba(0,0,0,0.1)]"></div></div>
                            <div className="mb-6"><div className="grid grid-cols-5 gap-2 md:grid-cols-10 md:gap-4">{categories.map((item) => (<div key={item.id} onClick={() => item.action === 'more' ? setShowMoreMenu(true) : handleCategoryClick(item.type, item.label)} className="flex flex-col items-center gap-1 cursor-pointer hover:bg-white/50 p-2 rounded-xl transition"><div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${item.color} shadow-sm active:scale-90 transition`}>{React.cloneElement(item.icon, { size: 20 })}</div><span className="text-[10px] font-medium text-gray-600">{t(item.label)}</span></div>))}</div></div>
                            {/* ä¿®æ”¹: å¢åŠ â€œå‘å¸ƒéœ€æ±‚â€æŒ‰é’® */}
                            <div className="mb-6">
                                <div className="bg-gradient-to-r from-brand-orange to-red-500 rounded-2xl p-4 text-white shadow-lg md:p-8">
                                    <div className="flex justify-between items-center mb-2">
                                        <h2 className="font-bold text-lg flex items-center gap-1 md:text-2xl"><Zap size={18} fill="white" /> {t('sos')}</h2>
                                        <button onClick={handleSOSClick} className="bg-white text-red-500 px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm active:bg-gray-100">{t('call')}</button>
                                    </div>
                                    <p className="text-orange-100 text-xs mb-4">{t('sos_desc')}</p>
                                    <div className="h-px bg-white/20 my-3"></div>
                                    <div className="flex justify-between items-center">
                                        <div className="text-sm font-bold flex items-center gap-1"><MessageSquare size={16}/> éç´§æ€¥éœ€æ±‚?</div>
                                        <button onClick={() => toggleModal('postRequest', true)} className="bg-white/20 border border-white/40 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-white/30 transition">å‘å¸ƒéœ€æ±‚å¸–</button>
                                    </div>
                                </div>
                            </div>
                            <div className="mb-6"><div className="flex justify-between items-center mb-2"><h3 className="font-bold text-gray-800 text-sm flex items-center gap-1"><Megaphone size={14} className="text-brand-blue" /> {t('promo')}</h3><span className="text-[10px] text-gray-400">{t('view_all')}</span></div><div ref={sliderRef} onMouseDown={handleMouseDown} onMouseLeave={handleMouseLeave} onMouseUp={handleMouseUp} onMouseMove={handleMouseMove} className={`flex overflow-x-auto gap-3 no-scrollbar pb-2 cursor-grab ${isDown ? 'cursor-grabbing' : ''}`}>{promotions.map((promo) => (<div key={promo.id} className={`flex-shrink-0 w-64 h-24 rounded-xl bg-gradient-to-r ${promo.color} p-4 text-white shadow-md flex flex-col justify-center relative overflow-hidden select-none`}><div className="absolute right-0 top-0 w-16 h-16 bg-white/10 rounded-full -mr-8 -mt-8 blur-lg"></div><h4 className="font-bold text-lg relative z-10">{t(promo.title)}</h4><p className="text-white/80 text-xs relative z-10">{t(promo.sub)}</p></div>))}</div></div>
                            <div><h3 className="font-bold text-gray-800 text-lg mb-3">{t('rec_sifu')}</h3><div className="space-y-3 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4">{sifuData.map((pro) => (<div key={pro.id} onClick={() => setSelectedSifu(pro)} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer group"><div className="flex items-start"><div className="w-14 h-14 bg-gray-50 rounded-lg mr-3 flex-shrink-0 flex items-center justify-center text-gray-400"><Key size={24} /></div><div className="flex-1"><div className="flex justify-between"><h4 className="font-bold text-gray-800 text-sm">{pro.name}</h4><span className="font-bold text-brand-blue text-sm">{pro.price}</span></div><p className="text-xs text-gray-500 mb-1">{pro.skill}</p><div className="flex gap-2 text-[10px] text-gray-400"><span className="flex items-center text-yellow-500"><Star size={10} className="fill-current mr-0.5" /> {pro.rating}</span></div></div></div></div>))}</div></div>
                        </div>
                    </div>
                </div>
            );
        }
        if (activeTab === 'orders') {
            return (
                <div className="flex flex-col h-full bg-gray-50 animate-slide-up">
                    <div className="bg-white p-4 pt-8 sticky top-0 z-10 border-b border-gray-100 shadow-sm md:px-8">
                        <h2 className="text-xl font-bold text-gray-800 max-w-4xl mx-auto mb-4">{t('my_orders')}</h2>
                        <div className="flex gap-4 border-b border-gray-100">
                            <button onClick={() => setOrderTab('active')} className={`pb-2 text-sm font-bold ${orderTab === 'active' ? 'text-brand-blue border-b-2 border-brand-blue' : 'text-gray-400'}`}>è¿›è¡Œä¸­</button>
                            <button onClick={() => setOrderTab('requests')} className={`pb-2 text-sm font-bold ${orderTab === 'requests' ? 'text-brand-blue border-b-2 border-brand-blue' : 'text-gray-400'}`}>æˆ‘çš„éœ€æ±‚ ({myRequests.length})</button>
                            <button onClick={() => setOrderTab('history')} className={`pb-2 text-sm font-bold ${orderTab === 'history' ? 'text-brand-blue border-b-2 border-brand-blue' : 'text-gray-400'}`}>å†å²</button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 pb-24 max-w-4xl mx-auto w-full">
                         {orderTab === 'active' && (
                             <>
                                <div className="bg-white rounded-2xl shadow-lg border border-blue-100 overflow-hidden mb-8"><div className="bg-brand-blue p-4 text-white flex justify-between items-center"><div><span className="text-xs opacity-80">{t('eta')}</span><div className="font-bold text-2xl">{activeOrder.eta}</div></div><div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><Clock size={24} className="animate-pulse" /></div></div><div className="h-32 bg-gray-100 relative"><iframe width="100%" height="100%" frameBorder="0" scrolling="no" marginHeight="0" marginWidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=101.68685913085939%2C3.006931201367338%2C101.72668457031251%2C3.033504907992788&amp;layer=mapnik" className="w-full h-full opacity-60 mix-blend-multiply"></iframe><div className="absolute inset-0 flex items-center justify-center"><span className="bg-white px-3 py-1 rounded-full shadow-md text-xs font-bold text-gray-600 flex items-center gap-1"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> {t('moving')}</span></div></div><div className="p-4 border-b border-gray-100 flex items-center justify-between"><div className="flex items-center gap-3"><div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center"><User size={20} className="text-gray-500" /></div><div><h4 className="font-bold text-gray-800">{activeOrder.sifuName}</h4><p className="text-xs text-gray-500">{activeOrder.service}</p></div></div><div className="flex gap-2"><button className="p-2 bg-green-100 text-green-600 rounded-full"><MessageCircle size={20} /></button><button className="p-2 bg-blue-100 text-brand-blue rounded-full"><Phone size={20} /></button></div></div><div className="p-5 bg-gray-50/50"><div className="relative pl-2"><div className="absolute left-[15px] top-2 bottom-4 w-0.5 bg-gray-200"></div>{activeOrder.timeline.map((step, idx) => (<div key={idx} className="flex gap-4 mb-6 relative z-10 last:mb-0"><div className={`w-4 h-4 rounded-full flex-shrink-0 border-2 ${step.done ? 'bg-brand-blue border-brand-blue' : step.current ? 'bg-white border-brand-orange animate-pulse' : 'bg-gray-100 border-gray-300'}`}>{step.done && <CheckCircle size={10} className="text-white m-auto" />}</div><div className={`${step.done || step.current ? 'opacity-100' : 'opacity-40'}`}><p className={`text-sm font-bold ${step.current ? 'text-brand-orange' : 'text-gray-800'}`}>{step.text}</p><p className="text-xs text-gray-500">{step.time}</p></div></div>))}</div></div></div>
                             </>
                         )}
                         {orderTab === 'requests' && (
                             <div className="space-y-4">
                                 {myRequests.map(req => (
                                     <div key={req.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                         <div className="flex justify-between items-start mb-2">
                                             <span className="bg-blue-50 text-brand-blue text-[10px] font-bold px-2 py-1 rounded">{req.category}</span>
                                             <span className="text-[10px] text-gray-400">{req.time}</span>
                                         </div>
                                         <h3 className="font-bold text-gray-800 mb-1">{req.title}</h3>
                                         <p className="text-xs text-gray-500 mb-3">{req.desc}</p>
                                         <div className="bg-gray-50 p-3 rounded-xl">
                                             <h4 className="text-xs font-bold text-gray-700 mb-2">å¸ˆå‚…æŠ¥ä»·/ç•™è¨€ ({req.comments.length})</h4>
                                             {req.comments.length > 0 ? (
                                                 req.comments.map(c => (
                                                     <div key={c.id} className="mb-2 last:mb-0 text-xs">
                                                         <div className="flex justify-between"><span className="font-bold">{c.sifu}</span><span className="text-brand-orange font-bold">{c.priceOffer}</span></div>
                                                         <p className="text-gray-500">{c.text}</p>
                                                     </div>
                                                 ))
                                             ) : (
                                                 <p className="text-[10px] text-gray-400">æš‚æ—¶è¿˜æ²¡æœ‰å¸ˆå‚…æŠ¥ä»·ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚</p>
                                             )}
                                         </div>
                                     </div>
                                 ))}
                                 <button onClick={() => toggleModal('postRequest', true)} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold text-sm flex items-center justify-center gap-2 hover:border-brand-blue hover:text-brand-blue transition"><Plus size={16}/> å‘å¸ƒæ–°éœ€æ±‚</button>
                             </div>
                         )}
                         {orderTab === 'history' && (
                             <div className="space-y-3">{pastOrders.map((order) => (<div key={order.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400"><Wrench size={18} /></div><div><h4 className="font-bold text-gray-800 text-sm">{order.sifu}</h4><p className="text-xs text-gray-400">{order.service} â€¢ {order.date}</p></div></div><div className="text-right"><div className="font-bold text-gray-800 text-sm">{order.price}</div><div className="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full inline-block mt-1">{order.status}</div></div></div>))}</div>
                         )}
                    </div>
                </div>
            );
        }
        // ... (ä¿ç•™ voucher, chat, me tab çš„ä»£ç ) ...
        if (activeTab === 'voucher') {
            return (
                <div className="flex flex-col h-full bg-gray-50 animate-slide-up">
                    <div className="bg-white p-4 pt-8 sticky top-0 z-10 border-b border-gray-100 shadow-sm flex justify-between items-center md:px-8"><h2 className="text-xl font-bold text-gray-800 max-w-4xl mx-auto">{t('my_vouchers')}</h2><button onClick={() => setShowVoucherRules(true)} className="text-xs text-brand-blue font-bold cursor-pointer hover:bg-blue-50 px-2 py-1 rounded">{t('rules')}</button></div>
                    <div className="flex-1 overflow-y-auto p-4 pb-24 max-w-4xl mx-auto w-full">
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6"><label className="text-xs text-gray-400 font-bold mb-2 block uppercase tracking-wider">{t('enter_code')}</label><div className="flex gap-2"><input type="text" placeholder={t('promo_placeholder')} className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-brand-blue uppercase" /><button className="bg-gray-800 text-white text-xs font-bold px-4 py-2 rounded-lg active:scale-95 transition">{t('redeem')}</button></div></div>
                        <div className="space-y-4">{vouchersData.map((v) => (<div key={v.id} className="relative flex bg-white rounded-xl shadow-md overflow-hidden min-h-[100px]"><div className={`w-28 bg-gradient-to-br ${v.color} p-3 flex flex-col items-center justify-center text-white relative`}><div className="absolute -right-3 top-1/2 -mt-3 w-6 h-6 bg-gray-50 rounded-full z-10"></div><span className="font-bold text-2xl shadow-sm">{v.value}</span><span className="text-[10px] font-medium opacity-80 tracking-widest">{v.sub}</span></div><div className="flex-1 p-4 flex flex-col justify-between relative"><div className="absolute left-0 top-2 bottom-2 border-l-2 border-dashed border-gray-200"></div><div><h3 className="font-bold text-gray-800">{t(v.title)}</h3><p className="text-xs text-gray-500 mt-1">{t(v.condition)}</p></div><div className="flex justify-between items-end mt-3"><span className="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded">{t(v.expiry)}</span><button className={`text-xs font-bold px-3 py-1.5 rounded-full border ${v.type === 'cash' ? 'text-brand-orange border-brand-orange' : 'text-brand-blue border-brand-blue'}`}>{t('use_now')}</button></div></div></div>))}</div>
                        <div className="mt-8 text-center"><p className="text-xs text-gray-300">{t('no_more')}</p></div>
                    </div>
                </div>
            );
        }
        if (activeTab === 'chat') {
            return (
                <div className="flex flex-col h-full bg-gray-50 animate-slide-up">
                    <div className="bg-white p-4 pt-8 sticky top-0 z-10 border-b border-gray-100 shadow-sm flex justify-between items-center md:px-8"><h2 className="text-xl font-bold text-gray-800 max-w-4xl mx-auto">{t('messages')} (3)</h2><button className="text-brand-blue"><MoreVertical size={20} /></button></div>
                    <div className="flex-1 overflow-y-auto p-4 pb-24 max-w-4xl mx-auto w-full">
                        <div className="mb-4 relative"><input type="text" placeholder={t('search_contact')} className="w-full bg-white border border-gray-200 py-2 pl-9 pr-4 rounded-lg text-sm focus:outline-none focus:border-brand-blue" /><Search size={16} className="absolute left-3 top-2.5 text-gray-400" /></div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">{chatList.map((chat) => (<div key={chat.id} onClick={() => setActiveChat(chat)} className="flex items-center p-4 border-b border-gray-50 last:border-0 hover:bg-gray-50 transition cursor-pointer"><div className={`w-12 h-12 rounded-full flex items-center justify-center mr-3 flex-shrink-0 ${chat.bg}`}>{chat.avatar}</div><div className="flex-1 min-w-0"><div className="flex justify-between items-baseline mb-1"><h4 className="font-bold text-gray-800 text-sm truncate">{chat.name}</h4><span className="text-[10px] text-gray-400">{chat.time}</span></div><p className="text-xs text-gray-500 truncate">{chat.lastMsg}</p></div>{chat.unread > 0 && (<div className="ml-2 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-[10px] text-white font-bold">{chat.unread}</div>)}</div>))}</div>
                    </div>
                </div>
            );
        }
        if (activeTab === 'me') {
            return (
                <div className="flex flex-col h-full bg-gray-50 animate-slide-up relative">
                    <div className="flex-1 overflow-y-auto pb-24 no-scrollbar">
                        <div className="bg-brand-blue p-6 pb-12 rounded-b-[2rem] md:rounded-none md:pb-20">
                            <div className="flex items-center gap-4 text-white max-w-4xl mx-auto">
                                <div className="w-16 h-16 rounded-full bg-white/20 border-2 border-white/50 flex items-center justify-center text-2xl font-bold backdrop-blur-sm overflow-hidden cursor-pointer" onClick={() => toggleModal('profile', true)}>{userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : "A"}</div>
                                <div><h2 className="font-bold text-xl">{userProfile.name}</h2><p className="text-blue-100 text-sm mb-1">{userProfile.phone}</p><span className="inline-block bg-gradient-to-r from-yellow-300 to-yellow-500 text-yellow-900 text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">{t('gold_member')}</span></div>
                                <button onClick={() => toggleModal('profile', true)} className="ml-auto p-2 bg-white/10 rounded-full hover:bg-white/20 transition"><Settings size={20} /></button>
                            </div>
                        </div>
                        <div className="px-4 max-w-4xl mx-auto w-full">
                            <div className="bg-white rounded-2xl shadow-xl p-5 -mt-8 relative z-10 flex justify-between items-center mb-6 border border-gray-100">
                                <div><p className="text-xs text-gray-400 font-medium mb-1">{t('balance')}</p><h3 className="text-2xl font-bold text-gray-800">RM 120.50</h3></div>
                                <div className="flex gap-3"><button onClick={() => toggleModal('topup', true)} className="flex flex-col items-center gap-1 group"><div className="w-10 h-10 bg-blue-50 text-brand-blue rounded-full flex items-center justify-center group-hover:bg-brand-blue group-hover:text-white transition shadow-sm"><Plus size={20} /></div><span className="text-[10px] text-gray-500 font-medium">{t('topup')}</span></button><button onClick={() => toggleModal('withdraw', true)} className="flex flex-col items-center gap-1 group"><div className="w-10 h-10 bg-orange-50 text-brand-orange rounded-full flex items-center justify-center group-hover:bg-brand-orange group-hover:text-white transition shadow-sm"><Wallet size={18} /></div><span className="text-[10px] text-gray-500 font-medium">{t('withdraw')}</span></button></div>
                            </div>
                            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                                <div onClick={() => toggleModal('address', true)} className="flex items-center p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition"><div className="w-8 h-8 rounded-full bg-blue-50 text-brand-blue flex items-center justify-center mr-3"><MapPin size={16} /></div><div className="flex-1"><h4 className="text-sm font-medium text-gray-700">{t('my_address')}</h4></div><span className="text-xs text-gray-400 mr-2">{t('set_default')}</span><ChevronRight size={16} className="text-gray-300" /></div>
                                <div onClick={() => toggleModal('payment', true)} className="flex items-center p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition"><div className="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center mr-3"><CreditCard size={16} /></div><div className="flex-1"><h4 className="text-sm font-medium text-gray-700">{t('payment_method')}</h4></div><span className="text-xs text-gray-400 mr-2">{cardList.length} å¼ å¡</span><ChevronRight size={16} className="text-gray-300" /></div>
                                <div onClick={() => toggleModal('language', true)} className="flex items-center p-4 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition"><div className="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center mr-3"><Globe size={16} /></div><div className="flex-1"><h4 className="text-sm font-medium text-gray-700">{t('language')}</h4></div><span className="text-xs text-gray-400 mr-2">{lang === 'zh' ? 'ä¸­æ–‡' : lang === 'en' ? 'EN' : 'MS'}</span><ChevronRight size={16} className="text-gray-300" /></div>
                            </div>
                            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"><div onClick={() => toggleModal('help', true)} className="flex items-center p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition"><div className="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center mr-3"><HelpCircle size={16} /></div><div className="flex-1"><h4 className="text-sm font-medium text-gray-700">{t('help_center')}</h4></div><ChevronRight size={16} className="text-gray-300" /></div><div onClick={() => toggleModal('logout', true)} className="flex items-center p-4 cursor-pointer hover:bg-gray-50 transition"><div className="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center mr-3"><LogOut size={16} /></div><div className="flex-1"><h4 className="text-sm font-medium text-red-500">{t('logout')}</h4></div></div></div>
                            <div className="h-8"></div>
                        </div>
                    </div>
                </div>
            );
        }
        return null;
    };

    return (
        <div className="flex flex-col h-[100dvh] bg-gray-50 font-sans w-full mx-auto shadow-2xl overflow-hidden relative">
            <div className="flex-1 flex flex-col md:flex-row h-full overflow-hidden">
                {/* Desktop Side Nav */}
                <div className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 z-30">
                    <div className="p-6 text-brand-blue font-bold text-2xl flex items-center gap-2"><Wrench/> Sifu-Go</div>
                    <div className="flex-1 px-4 space-y-2">
                        {[{ id: 'find', l: 'é¦–é¡µ', i: <Search size={20} /> }, { id: 'orders', l: 'è®¢å•', i: <Clock size={20} /> }, { id: 'voucher', l: 'ä¼˜æƒ åˆ¸', i: <Ticket size={20} /> }, { id: 'chat', l: 'æ¶ˆæ¯', i: <MessageCircle size={20} /> }, { id: 'me', l: 'æˆ‘çš„', i: <User size={20} /> }].map(n => (
                            <button key={n.id} onClick={() => {
                                setActiveTab(n.id);
                                if(n.id === 'find') {
                                    setSelectedCategory(null); // ä¿®å¤ï¼šç‚¹å‡»é¦–é¡µæ—¶å…³é—­åˆ†ç±»å¼¹çª—
                                    setSosState('idle'); 
                                }
                            }} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${activeTab === n.id ? 'bg-brand-blue text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>
                                {n.i} <span>{n.l}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Main Viewport */}
                <div className="flex-1 relative h-full overflow-hidden">
                     {renderContent()}
                </div>
            </div>

            {/* Overlays */}
            {renderSOSModal()}
            {showVoucherRules && (<div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 p-6 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 relative animate-scale-up"><button onClick={() => setShowVoucherRules(false)} className="absolute right-4 top-4 text-gray-400 hover:text-gray-600"><X size={20} /></button><h3 className="text-lg font-bold text-gray-800 mb-4">{t('rules')}</h3><ul className="text-sm text-gray-600 space-y-3 list-disc pl-4"><li>ä¼˜æƒ åˆ¸ä¸å¯å…‘æ¢ç°é‡‘ã€‚</li><li>æ¯ç¬”è®¢å•ä»…é™ä½¿ç”¨ä¸€å¼ ã€‚</li></ul><button onClick={() => setShowVoucherRules(false)} className="w-full bg-brand-blue text-white font-bold py-3 rounded-xl mt-6">æˆ‘æ˜ç™½äº†</button></div></div>)}
            
            {/* Common Modals */}
            {modals.profile && (<div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-6 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 animate-scale-up"><h3 className="font-bold text-lg mb-4">{t('edit_profile')}</h3><div className="flex flex-col items-center mb-6"><div className="w-20 h-20 rounded-full bg-gray-100 overflow-hidden mb-2 relative group cursor-pointer flex justify-center items-center" onClick={() => fileInputRef.current.click()}>{userProfile.avatar ? <img src={userProfile.avatar} className="w-full h-full object-cover" /> : "A"}<div className="absolute inset-0 bg-black/30 hidden group-hover:flex items-center justify-center text-white"><Camera size={20} /></div></div><span className="text-xs text-brand-blue font-bold cursor-pointer" onClick={() => fileInputRef.current.click()}>{t('upload_photo')}</span><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} /></div><input type="text" value={userProfile.name} onChange={(e) => setUserProfile({ ...userProfile, name: e.target.value })} className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3" /><input type="text" value={userProfile.phone} onChange={(e) => setUserProfile({ ...userProfile, phone: e.target.value })} className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-gray-50 mb-6" /><div className="flex gap-3"><button onClick={() => toggleModal('profile', false)} className="flex-1 py-2 text-gray-500 font-bold text-sm bg-gray-100 rounded-lg">{t('cancel')}</button><button onClick={() => toggleModal('profile', false)} className="flex-1 py-2 bg-brand-blue text-white rounded-lg font-bold text-sm shadow-md">{t('save')}</button></div></div></div>)}
            {modals.address && (<div className="absolute inset-0 z-50 bg-gray-50 flex flex-col animate-slide-up md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[400px] md:h-[600px] md:rounded-2xl md:shadow-2xl md:border md:bg-white"><div className="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-10"><button onClick={() => toggleModal('address', false)}><ChevronLeft /></button><h3 className="font-bold text-lg">{t('my_address')}</h3></div><div className="p-4 space-y-3 flex-1 overflow-y-auto">{addressList.map(addr => (<div key={addr.id} onClick={() => handleSetDefaultAddress(addr.id)} className={`bg-white p-4 rounded-xl shadow-sm border-2 relative cursor-pointer transition ${addr.isDefault ? 'border-brand-blue bg-blue-50/30' : 'border-transparent hover:border-gray-200'}`}><div className="flex justify-between items-start mb-2"><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${addr.isDefault ? 'bg-brand-blue text-white' : 'bg-gray-100 text-gray-500'}`}>{addr.label} {addr.isDefault && `(${t('default')})`}</span><div className="flex items-center gap-2"><button onClick={(e) => handleDeleteAddress(addr.id, e)} className="text-gray-300 hover:text-red-500 transition p-1"><Trash2 size={16} /></button>{addr.isDefault && <CheckCircle size={16} className="text-brand-blue" />}</div></div><p className="text-sm font-bold text-gray-800 leading-snug">{addr.address}</p></div>))}<button onClick={() => toggleModal('addAddress', true)} className="w-full border-2 border-dashed border-gray-300 rounded-xl py-3 text-gray-400 font-bold text-sm mt-4 flex items-center justify-center gap-2 hover:border-brand-blue hover:text-brand-blue transition"><Plus size={16} /> {t('add_address')}</button><div className="h-20"></div></div></div>)}
            {modals.addAddress && (<div className="absolute inset-0 z-[60] bg-black/50 flex items-center justify-center p-6 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 animate-scale-up"><h3 className="font-bold text-lg mb-4">{t('add_address')}</h3><div className="flex gap-2 mb-4">{['Home', 'Office', 'Other'].map(label => (<button key={label} onClick={() => setNewAddr({ ...newAddr, label })} className={`flex-1 py-1.5 text-xs font-bold rounded border ${newAddr.label === label ? 'bg-brand-blue text-white border-brand-blue' : 'border-gray-200 text-gray-500'}`}>{label}</button>))}</div><textarea placeholder="è¾“å…¥è¯¦ç»†åœ°å€..." value={newAddr.detail} onChange={e => setNewAddr({ ...newAddr, detail: e.target.value })} className="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm h-24 resize-none bg-gray-50 focus:bg-white mb-6"></textarea><div className="flex gap-3"><button onClick={() => toggleModal('addAddress', false)} className="flex-1 py-2 text-gray-500 font-bold text-sm bg-gray-100 rounded-lg">{t('cancel')}</button><button onClick={handleAddAddress} className="flex-1 py-2 bg-brand-blue text-white rounded-lg font-bold text-sm shadow-md">{t('save')}</button></div></div></div>)}
            {modals.payment && (<div className="absolute inset-0 z-50 bg-gray-50 flex flex-col animate-slide-up md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[400px] md:h-[600px] md:rounded-2xl md:shadow-2xl md:border md:bg-white"><div className="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-10"><button onClick={() => toggleModal('payment', false)}><ChevronLeft /></button><h3 className="font-bold text-lg">{t('payment_method')}</h3></div><div className="p-4 space-y-3 flex-1 overflow-y-auto">{cardList.map(card => (<div key={card.id} className={`p-5 rounded-2xl shadow-lg relative overflow-hidden mb-2 ${card.type === 'visa' ? 'bg-gradient-to-r from-gray-800 to-gray-900 text-white' : 'bg-blue-500 text-white'}`}><div className="absolute right-0 top-0 w-20 h-20 bg-white/10 rounded-full -mr-5 -mt-5"></div><p className="text-xs opacity-70 mb-4">{card.brand}</p><p className="text-xl font-mono tracking-widest mb-4">{card.number}</p><div className="flex justify-between items-end"><span className="text-xs opacity-70">EXP {card.expiry}</span></div></div>))}<button onClick={() => toggleModal('addCard', true)} className="w-full border-2 border-dashed border-gray-300 rounded-xl py-3 text-gray-400 font-bold text-sm mt-4 flex items-center justify-center gap-2 hover:border-brand-blue hover:text-brand-blue transition"><Plus size={16} /> {t('bind_card')}</button><div className="h-20"></div></div></div>)}
            {modals.addCard && (<div className="absolute inset-0 z-[60] bg-black/50 flex items-center justify-center p-6 animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 animate-scale-up"><h3 className="font-bold text-lg mb-4">{t('bind_card')}</h3><input type="text" placeholder="å¡å·" value={newCard.no} onChange={e => setNewCard({ ...newCard, no: e.target.value })} className="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3" /><div className="flex gap-3 mb-3"><input type="text" placeholder="MM/YY" value={newCard.expiry} onChange={e => setNewCard({ ...newCard, expiry: e.target.value })} className="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-sm" /><input type="text" placeholder="CVV" value={newCard.cvv} onChange={e => setNewCard({ ...newCard, cvv: e.target.value })} className="flex-1 border border-gray-200 rounded-lg px-3 py-2 text-sm" /></div><div className="flex gap-3 mt-6"><button onClick={() => toggleModal('addCard', false)} className="flex-1 py-2 text-gray-500 font-bold text-sm bg-gray-100 rounded-lg">{t('cancel')}</button><button onClick={handleAddCard} className="flex-1 py-2 bg-brand-blue text-white rounded-lg font-bold text-sm shadow-md">{t('save')}</button></div></div></div>)}
            {modals.help && (<div className="absolute inset-0 z-50 bg-gray-50 flex flex-col animate-slide-up md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[400px] md:h-[600px] md:rounded-2xl md:shadow-2xl md:border md:bg-white"><div className="bg-white p-4 shadow-sm flex items-center gap-3 sticky top-0 z-10"><button onClick={() => toggleModal('help', false)}><ChevronLeft /></button><h3 className="font-bold text-lg">{t('help_center')}</h3></div><div className="p-4 flex-1 overflow-y-auto"><h4 className="font-bold text-gray-800 mb-3">{t('faq')}</h4><div className="space-y-3">{[{ q: "å¦‚ä½•é¢„çº¦ Sifu?", a: "åœ¨é¦–é¡µé€‰æ‹©æœåŠ¡ç±»å‹ï¼Œæµè§ˆå¸ˆå‚…åˆ—è¡¨ï¼Œç‚¹å‡»'ç«‹å³é¢„çº¦'å³å¯ã€‚" },{ q: "æ”¶è´¹æ ‡å‡†æ˜¯æ€æ ·çš„?", a: "æ‰€æœ‰æœåŠ¡å‡æœ‰èµ·æ­¥ä»·ã€‚å…·ä½“ä»·æ ¼ç”±å¸ˆå‚…ä¸Šé—¨æ£€æµ‹åæŠ¥ä»·ï¼Œæ‚¨åŒæ„åæ‰å¼€å§‹å·¥ä½œã€‚" },{ q: "å¦‚ä½•ç”³è¯·é€€æ¬¾?", a: "å¦‚æœæœåŠ¡æœªå®Œæˆæˆ–æœ‰äº‰è®®ï¼Œè¯·åœ¨è®¢å•é¡µé¢ç‚¹å‡»'è”ç³»å®¢æœ'ï¼Œæˆ‘ä»¬ä¼šä»‹å…¥å¤„ç†ã€‚" },{ q: "æ€æ ·æˆä¸º Sifu?", a: "è¯·ä¸‹è½½ 'Sifu-Pro' ç‰ˆæœ¬çš„ App è¿›è¡Œæ³¨å†Œå’ŒæŠ€èƒ½è®¤è¯ã€‚" }].map((item, i) => (<div key={i} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><div onClick={() => setExpandedFaq(expandedFaq === i ? null : i)} className="p-4 flex justify-between items-center cursor-pointer bg-white"><span className="text-sm text-gray-700 font-medium">{t(item.q)}</span><ChevronDown size={16} className={`text-gray-300 transition-transform ${expandedFaq === i ? 'rotate-180' : ''}`} /></div>{expandedFaq === i && <div className="px-4 pb-4 text-xs text-gray-500 bg-gray-50/50 leading-relaxed border-t border-gray-50 pt-2">{t(item.a)}</div>}</div>))}</div><button className="w-full bg-brand-blue text-white font-bold py-3 rounded-xl shadow-lg mt-8 flex items-center justify-center gap-2"><Headphones size={18} /> {t('contact_support')}</button><div className="h-20"></div></div></div>)}
			{/* Post Request Modal */}
			{modals.postRequest && (
			  <div className="fixed inset-0 z-[120] bg-black/50 flex items-end md:items-center md:justify-center animate-fade-in">
				<div className="bg-white w-full rounded-t-3xl p-6 pb-[110px] animate-slide-up md:rounded-2xl md:w-[420px] md:pb-6 md:shadow-2xl">
				  <div className="flex justify-between items-center mb-4">
					<h3 className="font-bold text-lg text-gray-800">å‘å¸ƒéœ€æ±‚å¸–</h3>
					<button onClick={() => toggleModal('postRequest', false)}>
					  <X size={20} className="text-gray-400" />
					</button>
				  </div>

				  <div className="space-y-3">
					<div>
					  <label className="text-xs font-bold text-gray-400 uppercase">åˆ†ç±»</label>
					  <select
						value={newRequest.cat}
						onChange={(e) => setNewRequest(prev => ({ ...prev, cat: e.target.value }))}
						className="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-brand-blue"
					  >
						<option value="æˆ¿å±‹ä¿®ç¼®">æˆ¿å±‹ä¿®ç¼®</option>
						<option value="å†·æ°”æœåŠ¡">å†·æ°”æœåŠ¡</option>
						<option value="æ°´ç®¡ç»´ä¿®">æ°´ç®¡ç»´ä¿®</option>
						<option value="ç”µå·¥æœåŠ¡">ç”µå·¥æœåŠ¡</option>
						<option value="å¼€é”æœåŠ¡">å¼€é”æœåŠ¡</option>
					  </select>
					</div>

					<div>
					  <label className="text-xs font-bold text-gray-400 uppercase">æ ‡é¢˜</label>
					  <input
						value={newRequest.title}
						onChange={(e) => setNewRequest(prev => ({ ...prev, title: e.target.value }))}
						placeholder="ä¾‹å¦‚ï¼šå¨æˆ¿æ°´ç®¡æ¼æ°´ï¼Œéœ€è¦å°½å¿«å¤„ç†"
						className="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-brand-blue"
					  />
					</div>

					<div>
					  <label className="text-xs font-bold text-gray-400 uppercase">æè¿°</label>
					  <textarea
						value={newRequest.desc}
						onChange={(e) => setNewRequest(prev => ({ ...prev, desc: e.target.value }))}
						placeholder="æè¿°é—®é¢˜ã€åœ°ç‚¹ã€æ—¶é—´ã€æ˜¯å¦æœ‰ç…§ç‰‡ç­‰..."
						className="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-brand-blue h-28 resize-none"
					  />
					</div>

					<button
					  onClick={handleSubmitRequest}
					  className="w-full bg-brand-blue text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition"
					>
					  å‘å¸ƒ
					</button>

					<button
					  onClick={() => toggleModal('postRequest', false)}
					  className="w-full py-3 rounded-xl font-bold text-gray-500 bg-gray-100"
					>
					  å–æ¶ˆ
					</button>
				  </div>
				</div>
			  </div>
			)}

            {['topup', 'withdraw', 'language', 'logout'].map(m => modals[m] && (<div key={m} className={`absolute inset-0 z-50 bg-black/50 ${m === 'logout' ? 'flex items-center justify-center p-6' : 'flex items-end md:items-center md:justify-center'} animate-fade-in`}>{m === 'logout' ? (<div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 text-center animate-scale-up"><div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><LogOut size={24} /></div><h3 className="font-bold text-lg text-gray-800 mb-2">{t('confirm_logout')}</h3><p className="text-xs text-gray-500 mb-6">{t('logout_desc')}</p><div className="flex gap-3"><button onClick={() => toggleModal('logout', false)} className="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm">{t('cancel')}</button><button onClick={handleLogout} className="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold text-sm shadow-md">{t('logout')}</button></div></div>) : (<div className="bg-white rounded-t-3xl w-full p-6 pb-[100px] animate-slide-up md:rounded-2xl md:w-[400px] md:pb-6 md:shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">{m === 'topup' ? t('topup') : m === 'withdraw' ? t('withdraw') : t('language')}</h3><button onClick={() => toggleModal(m, false)}><X size={20} className="text-gray-400" /></button></div>{m === 'language' ? (<div className="space-y-1">{[{ c: 'ms', l: 'Bahasa Melayu' }, { c: 'en', l: 'English' }, { c: 'zh', l: 'ä¸­æ–‡ (ç®€ä½“)' }].map(x => (<div key={x.c} onClick={() => { setLang(x.c); toggleModal('language', false); }} className={`p-4 rounded-xl flex justify-between items-center cursor-pointer ${lang === x.c ? 'bg-blue-50 border border-blue-100' : 'hover:bg-gray-50'}`}><span className={`text-sm font-medium ${lang === x.c ? 'text-brand-blue' : 'text-gray-700'}`}>{x.l}</span>{lang === x.c && <CheckCircle size={18} className="text-brand-blue" />}</div>))}</div>) : (<>{m === 'withdraw' && <div className="bg-gray-50 p-4 rounded-xl mb-4 flex justify-between items-center"><span className="text-sm text-gray-600">{t('avail_balance')}</span><span className="font-bold text-gray-800">RM 120.50</span></div>}<p className="text-xs text-gray-400 mb-2">{t('amount')}</p><input type="number" placeholder="0.00" className={`w-full text-3xl font-bold border-b border-gray-200 py-2 mb-6 focus:outline-none focus:border-${m === 'withdraw' ? 'brand-orange' : 'brand-blue'}`} />{m === 'topup' && <div className="grid grid-cols-3 gap-3 mb-6">{[20, 50, 100].map(a => <button key={a} className="border border-gray-200 rounded-xl py-2 text-sm font-medium hover:border-brand-blue text-gray-600">RM {a}</button>)}</div>}<button onClick={() => toggleModal(m, false)} className={`w-full text-white font-bold py-3 rounded-xl shadow-lg ${m === 'withdraw' ? 'bg-brand-orange' : 'bg-brand-blue'}`}>{t('confirm')}</button></>)}</div>)}</div>))}
            
            {/* More Menu Modal */}
            {showMoreMenu && (
                <div className="absolute inset-0 z-50 flex items-end md:items-center md:justify-center">
                    <div className="absolute inset-0 bg-black/40 transition-opacity" onClick={() => setShowMoreMenu(false)}></div>
                    <div className="w-full bg-white rounded-t-3xl p-6 shadow-2xl relative animate-slide-up md:rounded-2xl md:w-[600px] md:h-auto">
                        <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 md:hidden"></div>
                        <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg text-gray-800">{t('more_services')}</h3><button onClick={() => setShowMoreMenu(false)} className="p-1 bg-gray-100 rounded-full"><X size={20} className="text-gray-500" /></button></div>
                        <div className="grid grid-cols-4 gap-y-6">{moreServices.map((s, i) => (<div key={i} onClick={() => handleCategoryClick(s.type, s.label)} className="flex flex-col items-center gap-2 cursor-pointer hover:opacity-80 transition"><div className="w-12 h-12 p-2.5 bg-gray-50 rounded-2xl flex items-center justify-center text-xl shadow-sm border border-gray-100"><img src={s.icon} alt={t(s.label)} className="w-full h-full object-contain" /></div><span className="text-center text-xs text-gray-600 font-medium">{t(s.label)}</span></div>))}</div>
                    </div>
                </div>
            )}
            
            {/* Sifu Detail Overlay (Fixed z-[100] to cover everything) */}
            {selectedSifu && (
                <div className="fixed inset-0 z-[100] bg-white flex flex-col animate-slide-up md:fixed md:inset-0 md:bg-black/50 md:flex md:items-center md:justify-center">
                    <div className="flex flex-col h-full w-full bg-white md:w-[500px] md:h-[600px] md:rounded-2xl md:shadow-2xl md:overflow-hidden relative">
                        <div className="p-4 flex items-center border-b border-gray-100 sticky top-0 bg-white z-10"><button onClick={() => setSelectedSifu(null)} className="p-2 bg-gray-50 rounded-full hover:bg-gray-200 transition"><ChevronLeft size={24} className="text-gray-700" /></button><span className="ml-4 font-bold text-lg">{t('sifu_desc') || "å¸ˆå‚…ç®€ä»‹"}</span></div>
                        <div className="flex-1 overflow-y-auto pb-20 p-6">
                            <div className="text-center mb-6"><div className="w-24 h-24 bg-gray-100 rounded-full mx-auto flex items-center justify-center mb-4 border-4 border-white shadow-lg"><Shield size={40} className="text-brand-blue" /></div><h2 className="text-2xl font-bold text-gray-800">{selectedSifu.name}</h2><p className="text-gray-500">{selectedSifu.skill}</p></div>
                            <div className="flex justify-center gap-6 bg-gray-50 p-4 rounded-2xl mb-6"><div className="text-center"><span className="block font-bold text-xl text-brand-blue">{selectedSifu.rating}</span><span className="text-xs text-gray-400">è¯„åˆ†</span></div><div className="w-px bg-gray-200"></div><div className="text-center"><span className="block font-bold text-xl text-brand-blue">{selectedSifu.jobs}</span><span className="text-xs text-gray-400">æ¥å•</span></div></div>
                            <h3 className="font-bold text-lg mb-2">å…³äºæˆ‘</h3><p className="text-gray-600 text-sm leading-relaxed mb-6">{selectedSifu.bio}</p>
                        </div>
                        <div className="p-4 border-t border-gray-100 flex gap-3 bg-white"><button className="flex-1 bg-brand-orange text-white font-bold py-3 rounded-xl shadow-lg">ç«‹å³é¢„çº¦ ({selectedSifu.price})</button></div>
                    </div>
                </div>
            )}
            
            {/* Active Chat Detail (Fixed z-[100]) */}
            {activeChat && (
                <div className="fixed inset-0 z-[100] bg-white flex flex-col animate-slide-up md:fixed md:inset-0 md:bg-black/50 md:flex md:items-center md:justify-center">
                    <div className="flex flex-col h-full w-full bg-white md:w-[500px] md:h-[600px] md:rounded-2xl md:shadow-2xl md:overflow-hidden relative">
                        <div className="bg-white p-4 pt-8 sticky top-0 z-10 border-b border-gray-100 shadow-sm flex items-center gap-3"><button onClick={() => setActiveChat(null)} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><ChevronLeft size={20} /></button><div className="flex-1"><h2 className="font-bold text-gray-800 text-sm">{activeChat.name}</h2><p className="text-[10px] text-green-500 flex items-center gap-1"><span className="w-1.5 h-1.5 bg-green-500 rounded-full"></span> {t('online')}</p></div><button className="p-2 hover:bg-gray-50 rounded-full"><Phone size={20} className="text-brand-blue" /></button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"><div className="text-center text-xs text-gray-400 my-4">ä»Šå¤© 14:30</div>{chatHistoryMock.map((msg) => (<div key={msg.id} className={`flex ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}`}>{msg.sender === 'sifu' && (<div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-2 text-gray-500"><User size={14} /></div>)}<div className={`max-w-[70%] px-4 py-2 rounded-2xl text-sm shadow-sm ${msg.sender === 'me' ? 'bg-brand-blue text-white rounded-tr-none' : 'bg-white text-gray-700 rounded-tl-none'}`}>{msg.text}<div className={`text-[10px] mt-1 text-right ${msg.sender === 'me' ? 'text-blue-200' : 'text-gray-300'}`}>{msg.time}</div></div></div>))}</div>
                        <div className="p-4 bg-white border-t border-gray-100 flex gap-2"><input type="text" placeholder={t('type_msg')} className="flex-1 bg-gray-50 border border-gray-200 rounded-full px-4 text-sm focus:outline-none focus:border-brand-blue" /><button className="p-3 bg-brand-blue text-white rounded-full shadow-lg active:scale-95 transition"><Send size={18} /></button></div>
                    </div>
                </div>
            )}
            
            {/* Category Filter Sifu List (Fixed z-[90]) */}
            {selectedCategory && (
                <div className="fixed inset-0 z-[90] bg-gray-50 flex flex-col animate-slide-up md:fixed md:inset-0 md:left-64 md:z-0 md:bg-gray-50 md:h-full">
                    <div className="bg-white p-4 pt-8 sticky top-0 z-10 border-b border-gray-100 shadow-sm flex items-center gap-3"><button onClick={() => setSelectedCategory(null)} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><ChevronLeft size={20} /></button><div className="flex-1"><h2 className="font-bold text-gray-800 text-lg">{t(selectedCategory.label)}</h2><p className="text-xs text-gray-400">æ¨èå¸ˆå‚…åˆ—è¡¨</p></div><button className="p-2 hover:bg-gray-50 rounded-full"><Filter size={20} className="text-gray-500" /></button></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 md:pb-0">{sifuData.filter(s => s.category === selectedCategory.type).length > 0 ? (sifuData.filter(s => s.category === selectedCategory.type).map((pro) => (<div key={pro.id} onClick={() => setSelectedSifu(pro)} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50 transition cursor-pointer group animate-fade-in"><div className="flex items-start"><div className="w-14 h-14 bg-gray-50 rounded-lg mr-3 flex-shrink-0 flex items-center justify-center text-gray-400"><Key size={24} /></div><div className="flex-1"><div className="flex justify-between"><h4 className="font-bold text-gray-800 text-sm">{pro.name}</h4><span className="font-bold text-brand-blue text-sm">{pro.price}</span></div><p className="text-xs text-gray-500 mb-1">{pro.skill}</p><div className="flex gap-2 text-[10px] text-gray-400"><span className="flex items-center text-yellow-500"><Star size={10} className="fill-current mr-0.5" /> {pro.rating}</span><span className="flex items-center">{pro.dist}</span></div></div><div className="self-center pl-2"><ChevronRight size={20} className="text-gray-300 group-hover:text-brand-blue transition" /></div></div></div>))) : (<div className="flex flex-col items-center justify-center h-64 text-gray-400"><div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4"><Search size={32}/></div><p className="text-sm">æš‚æ—¶æ²¡æœ‰è¿™ä¸ªåˆ†ç±»çš„å¸ˆå‚…</p></div>)}</div>
                </div>
            )}
            
            {/* Mobile Bottom Nav */}
            <div className="md:hidden absolute bottom-0 w-full bg-white border-t border-gray-200 py-2 px-4 flex justify-between items-center z-20">
                {[{ id: 'find', l: 'nav_find', i: <Search size={22} /> }, { id: 'orders', l: 'nav_orders', i: <Clock size={22} /> }, { id: 'voucher', l: 'nav_voucher', i: <Ticket size={22} /> }, { id: 'chat', l: 'nav_chat', i: <MessageCircle size={22} /> }, { id: 'me', l: 'nav_me', i: <User size={22} /> }].map(n => (
                  <div key={n.id} onClick={() => setActiveTab(n.id)} className={`flex flex-col items-center w-1/5 cursor-pointer transition-colors duration-200 ${activeTab === n.id ? 'text-brand-blue' : 'text-gray-300'}`}>
                    {n.i}<span className="text-[10px] font-medium mt-1">{t(n.l)}</span>
                  </div>
                ))}
            </div>
        </div>
    );
};

export default App;